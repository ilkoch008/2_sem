<!DOCTYPE html>
<html class='v2' dir='ltr' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>
<head>
<link href='https://www.blogger.com/static/v1/widgets/2727757643-css_bundle_v2.css' rel='stylesheet' type='text/css'/>
<meta content='IE=EmulateIE7' http-equiv='X-UA-Compatible'/>
<meta content='width=1100' name='viewport'/>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
<meta content='blogger' name='generator'/>
<link href='http://psy-lob-saw.blogspot.com/favicon.ico' rel='icon' type='image/x-icon'/>
<link href='http://psy-lob-saw.blogspot.com/' rel='canonical'/>
<link rel="alternate" type="application/atom+xml" title="Psychosomatic, Lobotomy, Saw - Atom" href="http://psy-lob-saw.blogspot.com/feeds/posts/default" />
<link rel="alternate" type="application/rss+xml" title="Psychosomatic, Lobotomy, Saw - RSS" href="http://psy-lob-saw.blogspot.com/feeds/posts/default?alt=rss" />
<link rel="service.post" type="application/atom+xml" title="Psychosomatic, Lobotomy, Saw - Atom" href="https://www.blogger.com/feeds/5171098727364395242/posts/default" />
<link rel="me" href="https://plus.google.com/107269247235043577368" />
<!--[if IE]><script type="text/javascript" src="https://www.blogger.com/static/v1/jsbin/3762807459-ieretrofit.js"></script>
<![endif]-->
<link href='https://plus.google.com/107269247235043577368' rel='publisher'/>
<meta content='Blog on Java, Performance, Concurrency, NIO, Unsafe, Low latency, Programming, Software, Philosophy' name='description'/>
<meta content='http://psy-lob-saw.blogspot.com/' property='og:url'/>
<meta content='Psychosomatic, Lobotomy, Saw' property='og:title'/>
<meta content='Blog on Java, Performance, Concurrency, NIO, Unsafe, Low latency, Programming, Software, Philosophy' property='og:description'/>
<!--[if IE]> <script> (function() { var html5 = ("abbr,article,aside,audio,canvas,datalist,details," + "figure,footer,header,hgroup,mark,menu,meter,nav,output," + "progress,section,time,video").split(','); for (var i = 0; i < html5.length; i++) { document.createElement(html5[i]); } try { document.execCommand('BackgroundImageCache', false, true); } catch(e) {} })(); </script> <![endif]-->
<title>Psychosomatic, Lobotomy, Saw</title>
<style type='text/css'>@font-face{font-family:'Inconsolata';font-style:normal;font-weight:400;src:local('Inconsolata Regular'),local('Inconsolata-Regular'),url(//fonts.gstatic.com/s/inconsolata/v16/QldKNThLqRwH-OJ1UHjlKGlW5qhWxg.woff2)format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+1EA0-1EF9,U+20AB;}@font-face{font-family:'Inconsolata';font-style:normal;font-weight:400;src:local('Inconsolata Regular'),local('Inconsolata-Regular'),url(//fonts.gstatic.com/s/inconsolata/v16/QldKNThLqRwH-OJ1UHjlKGlX5qhWxg.woff2)format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face{font-family:'Inconsolata';font-style:normal;font-weight:400;src:local('Inconsolata Regular'),local('Inconsolata-Regular'),url(//fonts.gstatic.com/s/inconsolata/v16/QldKNThLqRwH-OJ1UHjlKGlZ5qg.woff2)format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}@font-face{font-family:'Permanent Marker';font-style:normal;font-weight:400;src:local('Permanent Marker Regular'),local('PermanentMarker-Regular'),url(//fonts.gstatic.com/s/permanentmarker/v7/Fh4uPib9Iyv2ucM6pGQMWimMp004La2Cfw.woff2)format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}</style>
<style id='page-skin-1' type='text/css'><!--
/*
-----------------------------------------------
Blogger Template Style
Name:     Simple
Designer: Blogger
URL:      www.blogger.com
----------------------------------------------- */

/* Content
----------------------------------------------- */
body {
font: normal normal 12px Verdana, Geneva, sans-serif;
color: #222222;
background: #eeaa00 none repeat scroll top left;
padding: 0 40px 40px 40px;
}
html body .region-inner {
min-width: 0;
max-width: 100%;
width: auto;
}
h2 {
font-size: 22px;
}
a:link {
text-decoration:none;
color: #ff9900;
}
a:visited {
text-decoration:none;
color: #cc6611;
}
a:hover {
text-decoration:underline;
color: #eeaa00;
}
.body-fauxcolumn-outer .fauxcolumn-inner {
background: transparent url(//www.blogblog.com/1kt/simple/body_gradient_tile_light.png) repeat scroll top left;
_background-image: none;
}
.body-fauxcolumn-outer .cap-top {
position: absolute;
z-index: 1;
height: 400px;
width: 100%;
}
.body-fauxcolumn-outer .cap-top .cap-left {
width: 100%;
background: transparent url(//www.blogblog.com/1kt/simple/gradients_light.png) repeat-x scroll top left;
_background-image: none;
}
.content-outer {
-moz-box-shadow: 0 0 40px rgba(0, 0, 0, .15);
-webkit-box-shadow: 0 0 5px rgba(0, 0, 0, .15);
-goog-ms-box-shadow: 0 0 10px #333333;
box-shadow: 0 0 40px rgba(0, 0, 0, .15);
margin-bottom: 1px;
}
.content-inner {
padding: 10px 10px;
}
.content-inner {
background-color: #ffffff;
}
/* Header
----------------------------------------------- */
.header-outer {
background: #cc6611 url(//www.blogblog.com/1kt/simple/gradients_light.png) repeat-x scroll 0 -400px;
_background-image: none;
}
.Header h1 {
font: normal normal 40px Permanent Marker;
color: #ffffff;
text-shadow: 1px 2px 3px rgba(0, 0, 0, .2);
}
.Header h1 a {
color: #ffffff;
}
.Header .description {
font-size: 140%;
color: #ffffff;
}
.header-inner .Header .titlewrapper {
padding: 22px 30px;
}
.header-inner .Header .descriptionwrapper {
padding: 0 30px;
}
/* Tabs
----------------------------------------------- */
.tabs-inner .section:first-child {
border-top: 0 solid #eeeeee;
}
.tabs-inner .section:first-child ul {
margin-top: -0;
border-top: 0 solid #eeeeee;
border-left: 0 solid #eeeeee;
border-right: 0 solid #eeeeee;
}
.tabs-inner .widget ul {
background: #f5f5f5 url(//www.blogblog.com/1kt/simple/gradients_light.png) repeat-x scroll 0 -800px;
_background-image: none;
border-bottom: 1px solid #eeeeee;
margin-top: 0;
margin-left: -30px;
margin-right: -30px;
}
.tabs-inner .widget li a {
display: inline-block;
padding: .6em 1em;
font: normal normal 14px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
color: #999999;
border-left: 1px solid #ffffff;
border-right: 1px solid #eeeeee;
}
.tabs-inner .widget li:first-child a {
border-left: none;
}
.tabs-inner .widget li.selected a, .tabs-inner .widget li a:hover {
color: #000000;
background-color: #eeeeee;
text-decoration: none;
}
/* Columns
----------------------------------------------- */
.main-outer {
border-top: 0 solid #eeeeee;
}
.fauxcolumn-left-outer .fauxcolumn-inner {
border-right: 1px solid #eeeeee;
}
.fauxcolumn-right-outer .fauxcolumn-inner {
border-left: 1px solid #eeeeee;
}
/* Headings
----------------------------------------------- */
div.widget > h2,
div.widget h2.title {
margin: 0 0 1em 0;
font: normal bold 12px Verdana, Geneva, sans-serif;
color: #000000;
}
/* Widgets
----------------------------------------------- */
.widget .zippy {
color: #999999;
text-shadow: 2px 2px 1px rgba(0, 0, 0, .1);
}
.widget .popular-posts ul {
list-style: none;
}
/* Posts
----------------------------------------------- */
h2.date-header {
font: normal bold 11px Arial, Tahoma, Helvetica, FreeSans, sans-serif;
}
.date-header span {
background-color: transparent;
color: #222222;
padding: inherit;
letter-spacing: inherit;
margin: inherit;
}
.main-inner {
padding-top: 30px;
padding-bottom: 30px;
}
.main-inner .column-center-inner {
padding: 0 15px;
}
.main-inner .column-center-inner .section {
margin: 0 15px;
}
.post {
margin: 0 0 25px 0;
}
h3.post-title, .comments h4 {
font: italic bold 20px Inconsolata;
margin: .75em 0 0;
}
.post-body {
font-size: 110%;
line-height: 1.4;
position: relative;
}
.post-body img, .post-body .tr-caption-container, .Profile img, .Image img,
.BlogList .item-thumbnail img {
padding: 2px;
background: #ffffff;
border: 1px solid #eeeeee;
-moz-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
-webkit-box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
box-shadow: 1px 1px 5px rgba(0, 0, 0, .1);
}
.post-body img, .post-body .tr-caption-container {
padding: 5px;
}
.post-body .tr-caption-container {
color: #222222;
}
.post-body .tr-caption-container img {
padding: 0;
background: transparent;
border: none;
-moz-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
-webkit-box-shadow: 0 0 0 rgba(0, 0, 0, .1);
box-shadow: 0 0 0 rgba(0, 0, 0, .1);
}
.post-header {
margin: 0 0 1.5em;
line-height: 1.6;
font-size: 90%;
}
.post-footer {
margin: 20px -2px 0;
padding: 5px 10px;
color: #666666;
background-color: #f9f9f9;
border-bottom: 1px solid #eeeeee;
line-height: 1.6;
font-size: 90%;
}
#comments .comment-author {
padding-top: 1.5em;
border-top: 1px solid #eeeeee;
background-position: 0 1.5em;
}
#comments .comment-author:first-child {
padding-top: 0;
border-top: none;
}
.avatar-image-container {
margin: .2em 0 0;
}
#comments .avatar-image-container img {
border: 1px solid #eeeeee;
}
/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
background-repeat: no-repeat;
background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}
.comments .comments-content .loadmore a {
border-top: 1px solid #999999;
border-bottom: 1px solid #999999;
}
.comments .comment-thread.inline-thread {
background-color: #f9f9f9;
}
.comments .continue {
border-top: 2px solid #999999;
}
/* Accents
---------------------------------------------- */
.section-columns td.columns-cell {
border-left: 1px solid #eeeeee;
}
.blog-pager {
background: transparent none no-repeat scroll top center;
}
.blog-pager-older-link, .home-link,
.blog-pager-newer-link {
background-color: #ffffff;
padding: 5px;
}
.footer-outer {
border-top: 0 dashed #bbbbbb;
}
/* Mobile
----------------------------------------------- */
body.mobile  {
background-size: auto;
}
.mobile .body-fauxcolumn-outer {
background: transparent none repeat scroll top left;
}
.mobile .body-fauxcolumn-outer .cap-top {
background-size: 100% auto;
}
.mobile .content-outer {
-webkit-box-shadow: 0 0 3px rgba(0, 0, 0, .15);
box-shadow: 0 0 3px rgba(0, 0, 0, .15);
}
.mobile .tabs-inner .widget ul {
margin-left: 0;
margin-right: 0;
}
.mobile .post {
margin: 0;
}
.mobile .main-inner .column-center-inner .section {
margin: 0;
}
.mobile .date-header span {
padding: 0.1em 10px;
margin: 0 -10px;
}
.mobile h3.post-title {
margin: 0;
}
.mobile .blog-pager {
background: transparent none no-repeat scroll top center;
}
.mobile .footer-outer {
border-top: none;
}
.mobile .main-inner, .mobile .footer-inner {
background-color: #ffffff;
}
.mobile-index-contents {
color: #222222;
}
.mobile-link-button {
background-color: #ff9900;
}
.mobile-link-button a:link, .mobile-link-button a:visited {
color: #ffffff;
}
.mobile .tabs-inner .section:first-child {
border-top: none;
}
.mobile .tabs-inner .PageList .widget-content {
background-color: #eeeeee;
color: #000000;
border-top: 1px solid #eeeeee;
border-bottom: 1px solid #eeeeee;
}
.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
border-left: 1px solid #eeeeee;
}
.blogger-clickTrap {
display: none!important;
}

--></style>
<style id='template-skin-1' type='text/css'><!--
body {
min-width: 1080px;
}
.content-outer, .content-fauxcolumn-outer, .region-inner {
min-width: 1080px;
max-width: 1080px;
_width: 1080px;
}
.main-inner .columns {
padding-left: 0px;
padding-right: 250px;
}
.main-inner .fauxcolumn-center-outer {
left: 0px;
right: 250px;
/* IE6 does not respect left and right together */
_width: expression(this.parentNode.offsetWidth -
parseInt("0px") -
parseInt("250px") + 'px');
}
.main-inner .fauxcolumn-left-outer {
width: 0px;
}
.main-inner .fauxcolumn-right-outer {
width: 250px;
}
.main-inner .column-left-outer {
width: 0px;
right: 100%;
margin-left: -0px;
}
.main-inner .column-right-outer {
width: 250px;
margin-right: -250px;
}
#layout {
min-width: 0;
}
#layout .content-outer {
min-width: 0;
width: 800px;
}
#layout .region-inner {
min-width: 0;
width: auto;
}
--></style>
<link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=5171098727364395242&amp;zx=69d7099b-6b24-49d8-ab99-dfcb4d44ff47' media='none' onload='if(media!=&#39;all&#39;)media=&#39;all&#39;' rel='stylesheet'/><noscript><link href='https://www.blogger.com/dyn-css/authorization.css?targetBlogID=5171098727364395242&amp;zx=69d7099b-6b24-49d8-ab99-dfcb4d44ff47' rel='stylesheet'/></noscript>

</head>
<body class='loading variant-bold'>
<div class='navbar section' id='navbar'><div class='widget Navbar' data-version='1' id='Navbar1'><script type="text/javascript">
    function setAttributeOnload(object, attribute, val) {
      if(window.addEventListener) {
        window.addEventListener('load',
          function(){ object[attribute] = val; }, false);
      } else {
        window.attachEvent('onload', function(){ object[attribute] = val; });
      }
    }
  </script>
<div id="navbar-iframe-container"></div>
<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
<script type="text/javascript">
      gapi.load("gapi.iframes:gapi.iframes.style.bubble", function() {
        if (gapi.iframes && gapi.iframes.getContext) {
          gapi.iframes.getContext().openChild({
              url: 'https://www.blogger.com/navbar.g?targetBlogID\x3d5171098727364395242\x26blogName\x3dPsychosomatic,+Lobotomy,+Saw\x26publishMode\x3dPUBLISH_MODE_BLOGSPOT\x26navbarType\x3dLIGHT\x26layoutType\x3dLAYOUTS\x26searchRoot\x3dhttps://psy-lob-saw.blogspot.com/search\x26blogLocale\x3den_GB\x26v\x3d2\x26homepageUrl\x3dhttp://psy-lob-saw.blogspot.com/\x26vt\x3d-6998472679836334764',
              where: document.getElementById("navbar-iframe-container"),
              id: "navbar-iframe"
          });
        }
      });
    </script><script type="text/javascript">
(function() {
var script = document.createElement('script');
script.type = 'text/javascript';
script.src = '//pagead2.googlesyndication.com/pagead/js/google_top_exp.js';
var head = document.getElementsByTagName('head')[0];
if (head) {
head.appendChild(script);
}})();
</script>
</div></div>
<div itemscope='itemscope' itemtype='http://schema.org/Blog' style='display: none;'>
<meta content='Psychosomatic, Lobotomy, Saw' itemprop='name'/>
<meta content='Blog on Java, Performance, Concurrency, NIO, Unsafe, Low latency, Programming, Software, Philosophy' itemprop='description'/>
</div>
<div class='body-fauxcolumns'>
<div class='fauxcolumn-outer body-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content'>
<div class='content-fauxcolumns'>
<div class='fauxcolumn-outer content-fauxcolumn-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<div class='content-outer'>
<div class='content-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left content-fauxborder-left'>
<div class='fauxborder-right content-fauxborder-right'></div>
<div class='content-inner'>
<header>
<div class='header-outer'>
<div class='header-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left header-fauxborder-left'>
<div class='fauxborder-right header-fauxborder-right'></div>
<div class='region-inner header-inner'>
<div class='header section' id='header'><div class='widget Header' data-version='1' id='Header1'>
<div id='header-inner'>
<div class='titlewrapper'>
<h1 class='title'>
Psychosomatic, Lobotomy, Saw
</h1>
</div>
<div class='descriptionwrapper'>
<p class='description'><span>It's X, you'll need Y, I'll get Z</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class='header-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</header>
<div class='tabs-outer'>
<div class='tabs-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left tabs-fauxborder-left'>
<div class='fauxborder-right tabs-fauxborder-right'></div>
<div class='region-inner tabs-inner'>
<div class='tabs no-items section' id='crosscol'></div>
<div class='tabs no-items section' id='crosscol-overflow'></div>
</div>
</div>
<div class='tabs-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='main-outer'>
<div class='main-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left main-fauxborder-left'>
<div class='fauxborder-right main-fauxborder-right'></div>
<div class='region-inner main-inner'>
<div class='columns fauxcolumns'>
<div class='fauxcolumn-outer fauxcolumn-center-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-left-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<div class='fauxcolumn-outer fauxcolumn-right-outer'>
<div class='cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left'>
<div class='fauxborder-right'></div>
<div class='fauxcolumn-inner'>
</div>
</div>
<div class='cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<!-- corrects IE6 width calculation -->
<div class='columns-inner'>
<div class='column-center-outer'>
<div class='column-center-inner'>
<div class='main section' id='main'><div class='widget Blog' data-version='1' id='Blog1'>
<div class='blog-posts hfeed'>

          <div class="date-outer">
        
<h2 class='date-header'><span>Wednesday, 11 July 2018</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='https://1.bp.blogspot.com/-Q0PXa8BLj4s/W0TNJi402ZI/AAAAAAAAD98/7nEZCNAgyHADAKbbKXVKHoij10kEOJEuACLcBGAs/s320/confusion.jpg' itemprop='image_url'/>
<meta content='5171098727364395242' itemprop='blogId'/>
<meta content='1460147307289974089' itemprop='postId'/>
<a name='1460147307289974089'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html'>How Inlined Code Makes For Confusing Profiles</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-1460147307289974089' itemprop='articleBody'>
<a href="https://1.bp.blogspot.com/-Q0PXa8BLj4s/W0TNJi402ZI/AAAAAAAAD98/7nEZCNAgyHADAKbbKXVKHoij10kEOJEuACLcBGAs/s1600/confusion.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" data-original-height="675" data-original-width="1024" height="210" src="https://1.bp.blogspot.com/-Q0PXa8BLj4s/W0TNJi402ZI/AAAAAAAAD98/7nEZCNAgyHADAKbbKXVKHoij10kEOJEuACLcBGAs/s320/confusion.jpg" width="320" /></a>Inlining is a powerful and common optimization technique used by compilers. <br />
But inlining combines with other optimizations to transform your code to such an extent that other tooling becomes confused, namely profilers.<br />
<div>
<ol>
<ol>
</ol>
</ol>
<h3>
Mommy, What is Inlining?</h3>
<a href="https://en.wikipedia.org/wiki/Inline_expansion" target="_blank">Inlining</a> is the mother of all optimizations (to quote C. Click), and mothers are awesome as we all know. Inlining is simply the practice of replacing a method call with the method body. This doesn't sound like much of an improvement, but it's potentially a massive win for a couple of reasons:<br />
<ul>
<li>Expanding the scope of other optimizations! calling a method with a constant parameter may just end up getting folded into a constant for instance. Most compilers take a view that you either know everything about a method, because it's the method you are compiling ATM, or you know next to nothing about it. Calling another method may end up blocking, or having some unknown side effect, or bring the world to an end. Inlining expands the horizons of all available optimizations into the inlined code. These benefits can be quite dramatic, eliminating much of the inlined code (callee) on the one hand and assisting in supporting assumptions about the compilation unit at hand (caller).</li>
<li>Very small methods call overhead may actually exceed the method cost. Importantly, and counter intuitively perhaps, the cost of calling a method is not fixed. The cost will depend for example on calling convention (whose job is it to keep track of registers), pre/post conditions (e.g. ordering and safepoints).</li>
</ul>
But Inlining is not without it's potential issues:<br />
<ul>
<li>"code explosion". If I have a method of size 128b and that method cannot be reduced in any form by the context of it's caller, every time I inline it I increase my code size by 128b (a bit less, as I can remove the calling related prologue/epilogue). This may lead to a very bloated application, which will put pressure on my instruction cache as well as the JVM code cache.&nbsp;</li>
<li>Increased CPU pressure from the compiler itself, being challenged with larger and larger compilation units will lead to higher compile times, increased CPU usage, delayed compilation etc.</li>
<li>Increasingly complex compilation units may result in less optimal code than simpler ones. This is a real world limitation, though I would think in theory the more context the compiler has to work with, and assuming an infinite amount of cpu/memory/monkeys to throw at the problem, the better overall result we should get. In practice I have seen several cases where limiting inlining can improve results.</li>
</ul>
Picking the right boundaries is challenging, but luckily we got them bright compiler engineers to worry about that. <br />
<br />
<h3>
How Much Inlining Can We Do?</h3>
<div>
The amount of inlining a compiler does will depend on many factors. I'm not going to get very far if I try and explain the heuristics involved in great detail but some basic dimensions to the problem are:</div>
<div>
<ul>
<li>Who is the callee? In Java almost all method calls are 'virtual'. This means that at runtime any number of implementations could possibly exist for a particular call. This is traditionally where you'd give up on inlining. To make inlining happen anyway the compiler must convert a virtual call into a static call before it can be inlined. The same code in a different runtime may induce different compiler decisions on this. JIT compilation allows the compiler to tailor the decision in a way that AOT compilation cannot (in a dynamic environment).&nbsp;</li>
<li>How big is the callee? Most compilers put some upper limit on how big a caller method can grow as well as how big can a callee method be and still get inlined. A very large caller will be blocked from further inlining and even a medium sized callee might be blocked from being inlined. What is considered big will depend on the compiler, configuration and the profile. Limitations on compilation time for JIT compilers also drive this decision, at least partially.</li>
<li>How deep is the already inlined stack? How many veils can the compiler pierce? What about recursion?</li>
</ul>
So, that's the general shape of the problem: Virtual x Size x Depth. And if you were gonna try and write an inlining strategy for a compiler you'd need allot more details, but we can keep going with this for now.</div>
<div>
<br /></div>
<h3>
How Much Inlining Does Java Actually Do?</h3>
<div>
And by Java I mean the Oracle JDK 8u161. These things change whimsically from run to run, release to release, JVM to JVM etc, so stick a big YMMV on this shit.<br />
We can have the JVM helpfully share with us compilation details via a bunch of flags, but most importantly for this feature we will need: <span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-XX:+PrintInlining -XX:+PrintCompilation</span> (output is a bit hard to reason about because concurrent logging...). <br />
<span style="font-family: inherit;">For the sake of demonstration, here's the output of the offer method of SpscArrayQueue from a throughput benchmark I run regularly for JCTools:</span></div>
<script src="https://gist.github.com/nitsanw/c104c92287ea785c8d30325ba18157dc.js"></script>

<br />
Some observations:<br />
<ul>
<li>Tiny methods and some intrinsics are inlined even by the early compilation.</li>
<li>The <i>offerSlowPath</i> method which is not inlined by the first compilation is inlined by the C2 compiler at a second pass. </li>
</ul>
This is not a particularly challenging piece of code, but I picked it because it is easy enough for a human to follow. Small methods get inlined, even if they are nested a bit in other tiny methods.<br />
There's a performance related nugget to dig here:<br />
<ul>
<li>I split the <i>offerSlowPath</i> method with the intent of not having it inlined (or at least leaving this decision to the compiler). The compiler decided it is better off inlined. Who's right? has the compiler defeated my puny human brain? am I as worthless as my mother in law suspects? these questions will be answered some other day.</li>
</ul>
<h3>
Where Do Profilers Come In? </h3>
In traditional Java profilers no attempt is made at distinguishing between inlined frames (calls to methods which have been inlined) and 'real' frames (real method calls on the stack). Telling the 2 apart can be useful:</div>
<div>
<ul>
<li>Inlining is often a good thing, so failure to inline a method can be worth looking into. It's also instructive to see just how much the compiler can inline, and how many layers of distraction it must cut through to get to where the actual code you want to run is. Excessive "Manager/Abstract/Adapter/Proxy/Wrapper/Impl/Dimple/Pimpl" layering however can still prevent inlining and may also lead to erectile dysfunction, early onset dementia and being knifed by your colleagues.</li>
<li>Top of stack hot methods which are not inlined present obvious curios. Perhaps callers are too large, or the method itself?</li>
<li>Multiple implementors of same methods which are not inlined indicate a megamorphic callsite. If one of these is significantly hotter than the rest you might be able to special case for it (peel off the callsite with an <i>instanceof</i> check, effectively rolling your own conditional inlining).</li>
</ul>
But missing out on some good opportunities is not the issue I'm concerned with in this post. The point I'd like to get across is that <b>Inlining makes an already confusing reality much much more confusing</b>.</div>
<div>
<br /></div>
<div>
<h3>
A Confusing Reality</h3>
CPUs execute instructions, these instructions are not our code but the product of a series of compilation and optimization steps. It follows that if we hope to learn where the bottleneck in our code/application is we must be able to translate back from CPU instructions (the product of C1/C2/Other JIT compilers) to bytecode (the product of javac/JVM language compiler/bytecode generating agent/Other) to Code coordinates (file + line or class + method).<br />
This is not a straight forward mapping because:<br />
<ul>
<li>Some instructions do not map to any bytecode: this can happen when the JVM generates code for it's own accounting purposes.</li>
<li>Some instructions map to many bytecodes: the compiler can be quite clever in substituting many operations with one specialized instruction, Or when the result of one computation can be reused elsewhere.</li>
<li>Some bytecodes do not map to Code: this can happen due to bytecode generation.</li>
<li>Sometimes the compiler just fails in it's book keeping :-(. </li>
</ul>
A modern JIT compiler employs a significant number of optimizations to any given method, allowing it to deliver us the speed we love, but making reverse engineering the instructions into code a challenge. The mapping rules employed by profiling tools trying to bridge this gap, and by the compilers trying to give them a usable index boil down to:</div>
<div>
<ul>
<li>We assume instruction X translates to at most 1 bytecode location.</li>
<li>When a mapping does not exist, find the nearest instruction Y which has a mapping and use that.</li>
</ul>
This is already confusing, as the imperfect mapping, coupled with the compiler's license to reorder code combine to make "nearest instruction" possibly be "not nearest line of code".<br />
The problem is made worse by the inaccuracy of the profiler observations themselves. It is a known issue, largely unsolved, that the reported instruction from which the mapping starts is often a few (in theory many) instructions away from the intended sample location. This can have a knock on effect on the ultimately blamed/mapped code. This issue was touched on in a <a href="http://psy-lob-saw.blogspot.com/2016/06/the-pros-and-cons-of-agct.html" target="_blank">previous post on AGCT profilers</a>.<br />
When looking at a single method this is often a pesky, but ultimately managable problem. Sure, the profiler pointed to line A, but any fool can see the problem is line B... silly little hobbit.<br />
<br />
<h3>
MOAR, BIGGER, CONFUSION</h3>
So, given that:</div>
<div>
<ul>
<li>The instruction reported is a few instructions off.</li>
<li>The instructions do not map perfectly to lines of code.</li>
<li>The order of instructions does not have to match the order of the code.</li>
</ul>
We can see how even a small inaccuracy can translate into a large distance in lines of code between the cost we are trying to profile and where we end up. This is made exponentially worse by inlining.</div>
<div>
Where we had one method, we now have many methods, from many classes. As the code gets pulled in it is subjected to the same compiler "remixing", but at an expanded horizon. For instance, a computation repeated in the caller and callee can now be done once. Considering that inlining 4-6 layers of indirection is very common the "LOC distance" between "near instructions" can end up being very confusing.</div>
<div>
I should really elaborate with some clear example, but I do not have a repeatable experiment to hand and already stalled with this article for a few months while distracted elsewhere. An interesting example of how this could work out is available <a href="https://github.com/elastic/elasticsearch/issues/26339#issuecomment-328079161" target="_blank">here</a>. In this issue we have the wrong instruction being blamed for the cost of a cache-miss in a loop. The cache miss originates in the bowels of an inlined LinkedHashMap::get. The nearest instruction with a mapping however is from Field::binaryValue(line 441) it's easy to see how this would end up a very misleading profile if considered from a code perspective. When observed at the assembly level the instruction slip is much easier (as much as reading assembly is easy) to see through, but profiling on the assembly level is something very few people do and very few tools support.<br />
<br />
<h3>
Summary</h3>
Inlining is good, and profiling is good. But profiling modern compiled inlined code presents us challenges which are not easily solvable by looking at the common output of most tools. The more sense the compiler makes of our code, it's context, it's execution tree, the less obvious the mapping between instructions and code.<br />
So, what can we do? I think we should have our tools approach the problem in 2 ways:<br />
<ol>
<li>Fuzzier profiles: What would happen if instead of assigning cost to a single instruction (and it's code coordinates) we distributed the cost on a range of instructions? We could have more or less sophisticated models, but even a naive bell curve around the sampled instruction would bring in more context to the profile, and may help. This is hypothetical, as I am not aware of any tools which attempt this ATM.</li>
<li>Differentiate between real/inlined frames: This is something the JVM is certainly capable of doing, but most APIs for profiling do not support. AFAIK only <a href="http://www.oracle.com/technetwork/server-storage/developerstudio/downloads/index.html" target="_blank">Oracle Studio</a> and perf/bcc + <a href="https://github.com/jvm-profiling-tools/perf-map-agent" target="_blank">perf-map-agent</a> support views on real vs. inlined. I tend to use the latter more than the former. There's talk of adding <a href="https://github.com/jvm-profiling-tools/async-profiler/issues/66" target="_blank">support for this into async-profiler</a>.</li>
</ol>
<br />
Many thanks to <a href="https://twitter.com/VladimirSitnikv" target="_blank">V. Sitnikov</a> for reviewing :-).<br />
<br />
This post is one of a few on the topic of profiling, check the other ones out:<br />
<ul>
<li><a class="K3JSBVB-c-g" href="http://psy-lob-saw.blogspot.com/2016/02/why-most-sampling-java-profilers-are.html">Why (Most) Sampling Java Profilers Are Fucking Terrible</a></li>
<li><a class="K3JSBVB-c-g" href="http://psy-lob-saw.blogspot.com/2016/06/the-pros-and-cons-of-agct.html">The Pros and Cons of AsyncGetCallTrace Profilers</a>&nbsp;</li>
<li><a class="K3JSBVB-c-g" href="http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html">Java Flame Graphs Introduction: Fire For Everyone!</a></li>
<li><a href="http://psy-lob-saw.blogspot.com/2015/07/jmh-perfasm.html">JMH perfasm explained: Looking at False Sharing on Conditional Inlining</a>&nbsp; </li>
</ul>
</div>
<div>
<ul>
</ul>
</div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'><span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html' itemprop='url'/>
<a class='timestamp-link' href='http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2018-07-11T09:36:00+01:00'>09:36:00</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html#comment-form' onclick=''>
2 comments:
    </a>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-1797904270'>
<a href='https://www.blogger.com/post-edit.g?blogID=5171098727364395242&postID=1460147307289974089&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1460147307289974089&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1460147307289974089&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1460147307289974089&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1460147307289974089&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1460147307289974089&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html' size='medium' width='300' annotation='inline'/></div>
</div>
<span class='post-backlinks post-comment-link'>
</span>
</div>
<div class='post-footer-line post-footer-line-2'><span class='post-labels'>
Labels:
<a href='http://psy-lob-saw.blogspot.com/search/label/Compiler' rel='tag'>Compiler</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Inlining' rel='tag'>Inlining</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Java' rel='tag'>Java</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JVM' rel='tag'>JVM</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Profiling' rel='tag'>Profiling</a>
</span>
</div>
<div class='post-footer-line post-footer-line-3'><span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Friday, 5 January 2018</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='https://4.bp.blogspot.com/-LDRul_hGjmQ/V2pRYAr6iAI/AAAAAAAADKo/eyKCo7pUnz0dz8k30kNBoc8-pjPKEhj3QCPcBGAYYCw/s200/the_good__the_bad_and_the_ugly_by_felonland-d46b6az.png' itemprop='image_url'/>
<meta content='5171098727364395242' itemprop='blogId'/>
<meta content='473421685632901258' itemprop='postId'/>
<a name='473421685632901258'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://psy-lob-saw.blogspot.com/2018/01/what-difference-jvm-makes.html'>What a difference a JVM makes?</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-473421685632901258' itemprop='articleBody'>
<a href="https://4.bp.blogspot.com/-LDRul_hGjmQ/V2pRYAr6iAI/AAAAAAAADKo/eyKCo7pUnz0dz8k30kNBoc8-pjPKEhj3QCPcBGAYYCw/s1600/the_good__the_bad_and_the_ugly_by_felonland-d46b6az.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" data-original-height="1125" data-original-width="900" height="200" src="https://4.bp.blogspot.com/-LDRul_hGjmQ/V2pRYAr6iAI/AAAAAAAADKo/eyKCo7pUnz0dz8k30kNBoc8-pjPKEhj3QCPcBGAYYCw/s200/the_good__the_bad_and_the_ugly_by_felonland-d46b6az.png" width="160" /></a>JDK 9 is out! But as a library writer, this means change, and change can go either way... Once we've satisfied that JCTools works with JDK9, what other observations can we make? Well, one of the main motivations for using JCTools is performance, and since the code has been predominantly tested and run with JDK8, is it even better with&nbsp;&nbsp;JDK9? is it worse?<br />
<br />
<h3>
A JVM gets into trouble</h3>
I started my comparison (and we will not cover anything else cause the fuckers broke early) with the simplest queue, the SpscArrayQueue:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">$ taskset -c 4-7 java -jar jctools-benchmarks/target/microbenchmarks.jar throughput.QueueThroughputBackoffNone -p qType=SpscArrayQueue -p qCapacity=131072 -jvmArgs="-Xmx1g -Xms1g"&nbsp;-i 5 -wi 15 -r 5 -w 1 -f 3</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Oracle8u144:</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.020 &#177; 0.020&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.093 &#177; 0.102&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; 361.161 &#177; 4.126&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Oracle9.0.1:</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.065 &#177; 0.269&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 5.987 &#177; 2.788&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; &nbsp;26.182 &#177; 2.273&nbsp; ops/us</span><br />
<div>
<br /></div>
<div>
Some explanations on method and results:<br />
<ul>
<li>This is running on my beefy laptop, lots of memory to spare,&nbsp;Xeon(R) CPU E3-1505M v6 @ 3.00GHz. I set the gov'nor to "userspace" and frequency to 2.8GHz to avoid CPU frequency scaling and turbo boosting while benchmarking. I use taskset above to pin the JVM process 1 logical core on each physical core, so no 2 threads share a core. Easier than disabling HT, and sufficient for this exploration.</li>
<li>The&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">QueueThroughputBackoffNone</span>&nbsp;benchmark is an all out throughput benchmark for queues where producers and consumers spin to offer/poll (<a href="http://psy-lob-saw.blogspot.com/2014/07/poll-me-maybe.html" target="_blank">with j.u.Queue semantics</a>). Failures are recorded and the throughput observed is the rate of successful polls per <b>microsecond</b>(so millions per second if you prefer that figure). The benchmark is run with a single producer and single consumer thread, and is known to be sensitive to producer/consumer speed balance as contending on empty/full queue can lead to degraded performance. <a href="http://psy-lob-saw.blogspot.com/2016/12/linked-array-queues-part-2-spsc.html" target="_blank">See some discussion of the benchmark here</a>.</li>
</ul>
</div>
<div>
<div>
<span style="font-family: inherit;">Back to the results. They is not good :(</span><br />
<span style="font-family: inherit;">Why would this happen? HOW COULD THIS HAPPEN!!!</span></div>
<div>
<span style="font-family: inherit;">I profiled this miserable little bastard only to find that&nbsp;</span><span style="font-family: inherit;">on the offer side of there's a previously unobserved bottleneck:</span></div>
</div>
<div>
<span style="font-family: inherit;"><script src="https://gist.github.com/nitsanw/732b691191c32576d5a441638007ce96.js"></script></span></div>
<div>
<span style="font-family: inherit;"><br /></span></div>
<div>
<div>
What's happening? The whole point of SPSC is that there's no need for a strong memory barrier, no need for lock add or CAS, just some careful ordering (<a href="http://psy-lob-saw.blogspot.co.za/2016/12/what-is-lazyset-putordered.html" target="_blank">using putOrdered/lazySet</a>). But here we got this LOCK ADDL (line 34) instruction spoiling all the fun and eating all the cycles (but the next line is getting all the blame, typical).<br />
Where did it come from?<b> I didn't put it there. </b>Note that this is add 0 to the base of the stack(-0x40), which is how a StoreLoad barrier is implemented (<a href="https://shipilev.net/blog/2014/on-the-fence-with-dependencies/" target="_blank">see interesting post on barrier implementation details</a>). But there's no volatile store in sight.</div>
</div>
<div>
<div>
<br />
<h3>
A JVM gets out of trouble</h3>
</div>
<div>
TBH, even before bothering to look at the assembly I reached for a big "usual suspect" for performance differences with JDK9: G1GC is the new default GC!</div>
<div>
I quickly verified this theory (that G1GC fucked this up for me) by re-running the same benchmark on JDK9 with the JDK8 default GC (-XX:+UseParallelGC). Got similar results to JDK8. Awesome-ish:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Oracle9.0.1 (-XX:+UseParallelGC)</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.059 &#177;&nbsp; 0.133&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.147 &#177;&nbsp; 0.251&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; 356.100 &#177;&nbsp; 6.305&nbsp; ops/us</span><br />
<div>
<br /></div>
<div>
The bottleneck I've hit? it's G1GC<a href="http://psy-lob-saw.blogspot.co.za/2014/10/the-jvm-write-barrier-card-marking.html" target="_blank"> card marking! I even wrote a post about it.</a>&nbsp;G1GC write barrier is quite different from CMS/Parallel. You'll notice that the barrier discussed there is a little different from the one we see here. Times, they are a changing...</div>
<div>
So... the G1GC write barrier is ANGRY. Why so angry?</div>
</div>
<div>
<script src="https://gist.github.com/nitsanw/c25e6e3969ac1b1575da71a79802035a.js"></script></div>
<div>
<br /></div>
<div>
What this means is that the&nbsp;<span style="background-color: white; white-space: pre-wrap;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">g1_write_barrier_post </span><span style="font-family: inherit;">is pissed because:</span></span><br />
<ul>
<li><span style="white-space: pre-wrap;">buffer (the backing array for the queue) and element (being offered) are from different regions</span></li>
<li><span style="white-space: pre-wrap;">element is not null</span></li>
<li><span style="white-space: pre-wrap;">card (for the buffer) is not young</span></li>
</ul>
<span style="white-space: pre-wrap;">Confusingly, when playing around with this issue I moved from a small machine (8gb) to a bigger one (32gb) and when running with a larger heap size specified the issue became allot less pronounced. This is because, if we set the size of the heap to 1g we get 1mb regions. </span><span style="white-space: pre-wrap;">If we set the size of the heap to 8g (set both mx and ms) however we get 4mb regions.</span><span style="white-space: pre-wrap;"> We can demonstrate this is the issue by running again with G1 and setting the region size:</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; white-space: pre-wrap;">Oracle9.0.1 (-XX:+UseG1GC -Xms1g -Xmx1g -XX:G1HeapRegionSize=4m)
offersFailed |    0.009 &#177;  0.033  ops/us
pollsFailed  |    0.252 &#177;  0.257  ops/us
pollsMade    |  183.827 &#177; 16.650  ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; white-space: pre-wrap;"><br /></span></div>
<div>
<span style="background-color: white; white-space: pre-wrap;"><span style="font-family: inherit;">So, still not so brilliant, but much better. This however implies that the improvement is due to the buffer and the element being allocated from the same region. This is purely a product of the benchmark and the chosen queue size, and is not typical of normal applications. It follows therefore (I think) that the behaviour we see here is quite likely to manifest pathologically for writes into long standing data structures, such as caches and queues.  And indeed if we increase the queue capacity the situation reverts back.</span></span><br />
All this messing around with JDK9 vs 8, runtime and GC impact comparison got me thinking of a couple of other regional collectors which might exhibit interesting behaviours here. Namely, Zing C4 and Shenandoah.<br />
<h3>
</h3>
<h3>
Put some Zing in that thing</h3>
I no longer work at Azul, so I had to get an <a href="https://www.azul.com/zing-oss-open-source-developer-access/" target="_blank">Open Source developer licence</a>, which was a breeze. I had to get some help with getting it all to work on Ubuntu 17.10, but 16.04 works off the bat (just follow the instructions). Starting with same parameters I got:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Zing8u17.12:</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.016 &#177; 0.010&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.013 &#177; 0.022&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; 302.288 &#177; 3.602&nbsp; ops/us</span><br />
<br /></div>
<div>
So Zing is 20% slower than Oracle ParallelGC here, but significantly better than G1 (either case). The JMH perfasm profiler does not work with Zing, though Azul does have a matching tool if you ask their support. To look at the profile I can either use ZVision, or Oracle Studio. I went with the latter, just because.<br />
The profile is hard to read, so I might go into it another time, but the question that seems obvious is: "Is Zing slower than Oracle+ParallelGC because of read/write barrier costs?"<br />
Zing after all is not a GC add-on to OpenJDK, but a completely different runtime+GC+compiler. In particular, Zing has recently switched from their old C2 like compiler (they forked paths many moons ago, but share a parent in Cliff Click), to an LLVM compiler which is now the default called Falcon. Testing that quickly by forcing Zing to use the C2 compiler yields the following results:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Zing8u17.12 (-XX:+UseC2):</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.034 &#177;&nbsp; 0.055&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.010 &#177;&nbsp; 0.017&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; 198.067 &#177; 31.983&nbsp; ops/us</span></div>
<div>
<br />
OK, so Falcon is a big win for Zing here, that's not the issue. Can we take the read and write barriers out of the picture?<br />
Sure we can! Zing supports 2 exciting GCs, you may have heard of the C4 GC, but Zing also supports the NoGC (it's very Zen), which is exactly what it sounds like. Running with no GC however may remove some positive effects GC has (e.g. not crashing when you've allocated more than your heap size and never collected, but also compacted relocated data), so we need to run NoGC with barriers, and NoGC with no barriers:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Zing8u17.12 (-XX:+GPGCNoGC -XX:+UseSVBs -XX:+UseLVBs):</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.035 &#177; 0.053&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.022 &#177; 0.043&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; 302.433 &#177; 2.675&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span>
<span style="font-family: inherit;">So, turning GC off makes no difference at all for this benchmark. That's great, as we can consider the removal of the barriers in isolation:</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Zing8u17.12 (-XX:+GPGCNoGC -XX:-UseSVBs -XX:-UseLVBs):</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.099 &#177;&nbsp; 0.070&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.027 &#177;&nbsp; 0.048&nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; 314.498 &#177; 17.872&nbsp; ops/us</span><br />
<span style="font-family: inherit;"><br /></span>
<span style="font-family: inherit;">Note that we see:</span><br />
<ol>
<li><span style="font-family: inherit;">Some improvement when barriers are removed.</span></li>
<li><span style="font-family: inherit;">Increased variance in results. This was due to large run to run variance which requires further digging.</span></li>
</ol>
So, while we can certainly see a difference here which is due to read/write barriers, that is not the whole story(maybe another day). My gut feeling is that Falcon is over inlining in this instance.<br />
<br />
<h3>
Oh Shenandoah</h3>
<div>
For Shenandoah I grabbed&nbsp;<a href="https://builds.shipilev.net/openjdk-shenandoah-jdk9/" target="_blank">one of the builds provided by the benevolent Shipilev here</a>. The build I got is this one:&nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">build 1.8.0-internal-jenkins_2017_11_12_03_35-b00</span></div>
<div>
Running with same heap size, but remembering that these builds don't default to Shenandoah:</div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Shenandoah (-XX:+UseShenandoahGC):</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; 0.031 &#177; 0.024&nbsp; ops/us</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.009 &#177; 0.025&nbsp; ops/us</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; 143.165 &#177; 3.172&nbsp; ops/us</span></div>
</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>
<div>
<span style="font-family: inherit;">Note that for Shenandoah there's not a massive imbalance between the offer/poll side, which indicates the issue is not pathological to one method or the other. For G1GC the problem was very clearly on the offer side. I had a peek at the assembly, but it's going to take me some time to get to grips with what's going on as it's a completely new set of tricks and quirks to look at. To get a high level view though, it's interesting to compare the HW counters for ParallelGC/Zing/G1/Shenandoah:</span></div>
<div>
<span style="font-family: inherit;"><br /></span></div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | PGC&nbsp; &nbsp; &nbsp;|&nbsp; Zing&nbsp; &nbsp; | G1&nbsp; &nbsp; &nbsp; | Shenandoah</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 368.055 |&nbsp; 303.039 | 194.538 | 140.236</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">CPI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; &nbsp;0.244 |&nbsp; &nbsp; 0.222 |&nbsp; &nbsp;0.352 |&nbsp; &nbsp;0.355&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cycles&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;7.629 |&nbsp; &nbsp; 9.319 |&nbsp; 14.764 |&nbsp; 19.998&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">instructions&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; 31.218 |&nbsp; &nbsp;41.972 |&nbsp; 42.002 |&nbsp; 56.294&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">branches&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;6.052 |&nbsp; &nbsp;11.672 |&nbsp; &nbsp;7.735 |&nbsp; &nbsp;9.017&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">L1-dcache-loads&nbsp; &nbsp; &nbsp; &nbsp;|&nbsp; 10.057 |&nbsp; &nbsp;10.936 |&nbsp; 14.320 |&nbsp; 26.707&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">L1-dcache-load-misses |&nbsp; &nbsp;0.067 |&nbsp; &nbsp; 0.149 |&nbsp; &nbsp;0.162 |&nbsp; &nbsp;0.100&nbsp;</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">L1-dcache-stores&nbsp; &nbsp; &nbsp; |&nbsp; &nbsp;3.553 |&nbsp; &nbsp; 3.042 |&nbsp; &nbsp;4.057 |&nbsp; &nbsp;5.064&nbsp;</span></div>
<div>
<br /></div>
</div>
<div>
<ul>
<li><span style="font-family: inherit;">This is a tiny workload, with 30-50 instructions per operation. I want to make it clear that it is very easy to have large differences between JVMs in such specific scenarios. This workload is all about loading and storing references in/out of an array. The data is all L1 resident, this is NOT A REPRESENTATIVE COMPARISON OF PERFORMANCE. If you want to know how these JVMs/GCs can help your application, run a </span>representative<span style="font-family: inherit;">&nbsp;workload with your application.</span></li>
<li><span style="font-family: inherit;">Seriously, let's not start a "my JVM/GC is better than thou" war here, OK people?</span></li>
<li><span style="font-family: inherit;">For simplicity of comparison I've run PGC/G1/Shenandoah out of the Shenandoah build that includes all 3. This makes for a simpler comparison as they all share the same compiler, but is not comparing with the relevant Oracle build (though it should be pretty much the same).</span></li>
<li>Zing has better CPI than PGC, but 10 more instructions per operation. These include 1 extra load, and 6 more branches. There are no branch misses in this workload, so the branches are just extra pressure on the branch predictor and more instructions. The 10 instructions difference translates into a 1.6 cycle difference, this is indicative of the success of the branch predictor in reducing the impact of the branches. These extra branches are the Zing LVB or read barrier. Each reference load costs at extra branch. Zing is doing less stores here, this is due to it's defensive approach to card marking.</li>
<li>G1 is given here with the good case (same region), as we already covered the bad case. We see G1 increasing the loads by 4 but using less branches than Zing, only 2 extra branches. These are related to the write barrier.&nbsp; We also see an extra store.</li>
<li>Shenandoah is using 3 extra instructions, and 16 extra loads. This is more than I expected. Since Shenandoah is using a Brooks-Pointer you would expect an extra load for each reference load. If we estimate from the Zing branch increase that we have 6 reference loads, I'd expect to have 6 extra loads on the Shenandoah side. I assume the other loads are related to card marking but I will need to learn more about this collector to say anything. <a href="http://cr.openjdk.java.net/~shade/shenandoah/jctools-QueueThroughputBackoffNone.txt" target="_blank">Shipilev has expanded on my rudimentary analysis here</a>. His conclusion: <span style="font-family: Times, Times New Roman, serif;"><u>"read and write barriers around Unsafe intrinsics are very active. C2 handling on Unsafe intrinsics uses CPUOrder membars a lot (http://hg.openjdk.java.net/shenandoah/jdk10/file/1819ee64325f/src/hotspot/share/opto/library_call.cpp#l2631),which may inhibit some barrier optimizations. The workload is also tied up in a very unlucky volatile-predicated loop that prevents barrier hoisting.</u></span><pre style="white-space: pre-wrap; word-wrap: break-word;"><span style="font-family: Times, Times New Roman, serif;"><u>Pending codegeneration improvements alleviate barrier costs even when they are not optimized."</u></span></pre>
</li>
</ul>
</div>
<span style="font-family: inherit;">Since I fully expect all the crusaders to get hot and bothered about the above I thought I'd throw in...</span><br />
<h3>
<span style="font-family: inherit;"><br /></span></h3>
<h3>
<span style="font-family: inherit;">A Holy Graal!</span></h3>
<div>
<span style="font-family: inherit;">Graal is the next gen compiler for HotSpot. Coming out of Oracle Labs and already running in Twitter production, I thought we should add another compiler dimension to this mix. To run Graal you can use: </span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">"<span style="background-color: white;">-XX:+UnlockExperimentalVMOptions -XX:+</span><wbr style="background-color: white;"></wbr><span style="background-color: white;">EnableJVMCI -XX:+UseJVMCICompiler"</span></span></div>
<div>
<span style="background-color: white;"><span style="font-family: inherit;">Comes included in the Java 9 package!!! So how does it do?</span></span></div>
<div>
<span style="background-color: white;"></span><br />
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">Oracle9.0.1 (-XX:+UseParallelGC -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:+UseJVMCICompiler)</span></span></div>
<span style="background-color: white;">
</span>
<br />
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed |&nbsp; &nbsp; &nbsp; &#8776; 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span></span></div>
<span style="background-color: white;">
</span>
<div>
<span style="background-color: white;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed&nbsp; |&nbsp; &nbsp; 0.347 &#177; 0.441&nbsp; ops/us</span></span></div>
<span style="background-color: white;">
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade&nbsp; &nbsp; |&nbsp; &nbsp;51.657 &#177; 3.568&nbsp; ops/us</span></div>
<div style="font-family: inherit;">
<br /></div>
<div>
<span style="font-family: inherit;">WHHHHHHHHYYYYYYYYYYYY!!!!!!!!</span></div>
<div>
<span style="font-family: inherit;"><script src="https://gist.github.com/nitsanw/db29b0193ac92136e0ce01e727bc6c1a.js"></script></span></div>
<div>
<span style="font-family: inherit;">Why can't we have nice things? Well... It turns out the good folks at Oracle Labs have not yet implemented putOrdered as nicely as C2 and Falcon has, and have thus competely buggered up my SPSC queue :(</span><br />
<span style="font-family: inherit;"><br /></span>
<br />
<h3>
<span style="font-family: inherit;">Summary: There Are Many JVMs In My Father's House</span></h3>
</div>
</span></div>
Variety is the spice of life as they say. In the narrow narrow usecase presented above we saw different JVMs/GCs/JITs throwing up all different behaviours. Some good, some less so. For this workload there's very little happening, no GC, no exciting vectorization opportunities, it's very limited. But, being limited has the benefit of simplicity and the opportunity to contrast.<br />
Also note that by profiling and refining this code on C2 I have perhaps overfitted it to one compiler at the expense of others, I certainly had more opportunity to eliminate any issues for the C2+ParallelGC scenario....<br />
<br />
I hope you enjoyed to tour, I encourage you to take these new friends home and play with them ;-).</div>
</div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'><span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://psy-lob-saw.blogspot.com/2018/01/what-difference-jvm-makes.html' itemprop='url'/>
<a class='timestamp-link' href='http://psy-lob-saw.blogspot.com/2018/01/what-difference-jvm-makes.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2018-01-05T17:27:00Z'>17:27:00</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://psy-lob-saw.blogspot.com/2018/01/what-difference-jvm-makes.html#comment-form' onclick=''>
12 comments:
    </a>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-1797904270'>
<a href='https://www.blogger.com/post-edit.g?blogID=5171098727364395242&postID=473421685632901258&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=473421685632901258&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=473421685632901258&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=473421685632901258&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=473421685632901258&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=473421685632901258&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://psy-lob-saw.blogspot.com/2018/01/what-difference-jvm-makes.html' size='medium' width='300' annotation='inline'/></div>
</div>
<span class='post-backlinks post-comment-link'>
</span>
</div>
<div class='post-footer-line post-footer-line-2'><span class='post-labels'>
Labels:
<a href='http://psy-lob-saw.blogspot.com/search/label/Benchmark' rel='tag'>Benchmark</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/C2' rel='tag'>C2</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Compiler' rel='tag'>Compiler</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/G1GC' rel='tag'>G1GC</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/GC' rel='tag'>GC</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Graal' rel='tag'>Graal</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Java' rel='tag'>Java</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Java9' rel='tag'>Java9</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JCTools' rel='tag'>JCTools</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JVM' rel='tag'>JVM</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JVM%20Internals' rel='tag'>JVM Internals</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Queue' rel='tag'>Queue</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/SPSC' rel='tag'>SPSC</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Throughpu' rel='tag'>Throughpu</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Zing' rel='tag'>Zing</a>
</span>
</div>
<div class='post-footer-line post-footer-line-3'><span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Tuesday, 14 February 2017</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='https://3.bp.blogspot.com/-aBBQ-aVwnVE/WKM5Ng4dIxI/AAAAAAAADgw/9sRqZZxi0U48WV8Ntw9PZjcjf547NElggCLcB/s320/fire-heart-961194_1920.jpg' itemprop='image_url'/>
<meta content='5171098727364395242' itemprop='blogId'/>
<meta content='1641272956353975323' itemprop='postId'/>
<a name='1641272956353975323'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html'>Java Flame Graphs Introduction: Fire For Everyone!</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-1641272956353975323' itemprop='articleBody'>
<a href="https://3.bp.blogspot.com/-aBBQ-aVwnVE/WKM5Ng4dIxI/AAAAAAAADgw/9sRqZZxi0U48WV8Ntw9PZjcjf547NElggCLcB/s1600/fire-heart-961194_1920.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="213" src="https://3.bp.blogspot.com/-aBBQ-aVwnVE/WKM5Ng4dIxI/AAAAAAAADgw/9sRqZZxi0U48WV8Ntw9PZjcjf547NElggCLcB/s320/fire-heart-961194_1920.jpg" width="320" /></a><a href="https://github.com/brendangregg/FlameGraph" target="_blank">FlameGraphs</a> are superawesome. If you've never heard of FlameGraphs and want to dive straight in the deep end, you should run off and check out the many many good resources provided by <a href="https://twitter.com/brendangregg" target="_blank">Brendan Greg</a> in his <a href="http://www.brendangregg.com/flamegraphs.html" target="_blank">one stop shop page here</a>. This post will give a quick intro and some samples to get you started with collecting profiles for all JVMs everywhere. I'm taking a slightly different tack then Brendan in presenting the topic, so if it turns out my explanations suck you should see if his make more sense.<br />
<br />
<h3>
What's the big deal?</h3>
<div>
If you've ever used a profiler to look at your code you will have seen 2 profile reports typically:</div>
<div>
<ol>
<li>Flat profile: This is often presented as the "top X" methods/classes/packages where <i>time&nbsp;</i>(or samples, or ticks or whatever) is spent. This is useful as it immediately shows up common bottlenecks across your code, but these are shown out of context. Sometimes this is enough, but often in larger application profiles context is significant. This representation is very useful when a method with a high overall impact is called from many callsites, making each callsite cheap but the method itself significant.</li>
<li>Tree profile: This profile will present you with a call tree where each method is a node with a total and self <i>time</i>&nbsp;quantity. The self measure implies the amount of time spent in the method itself(the amout of samples in which the method is the leaf), and total is for the total number of samples in which it shows up (leaf and node).</li>
</ol>
The problem with the tree view is that it is very unpleasant to navigate. Click click click click and as the stack deepens it becomes harder to look at and ingest. Enter FlameGraphs.</div>
<div>
FlameGraph represents a tree profile in a single interactive SVG where:</div>
<blockquote class="tr_bq">
<span style="background-color: white; text-align: justify;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><b>The x-axis shows the stack profile population, sorted alphabetically (it is not the passage of time), and the y-axis shows stack depth. Each rectangle represents a stack frame. The wider a frame is is, the more often it was present in the stacks. The top edge shows what is on-CPU, and beneath it is its ancestry.</b></span></span></blockquote>
Like most visualisations, it makes sense when you see it rather than explain it. Let start with data sets we can easily grasp and see what they look like.<br />
<br />
<h3>
Synthetic Samples For Starters</h3>
For instance, what does a single stack sample look like? The FlameGraphs SVG generating script takes as it's input a "collapsed stacks" file which has a dead simple format, frames separated by semi-colons followed by the number of times this stack was sampled. Here's a dummy handwritten example of a single sample file (call it sample.cstk):<br />
<span style="background-color: #cccccc;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">main;0;1;2;3;4;5;6;7;8;9;10 1</span></span><br />
<br />
We can feed this to the flames (now is a good time to clone this repo and try shit out):<br />
<span style="background-color: #eeeeee; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">flamegraph.pl single-stack.cstk &gt; single-stack.svg</span><br />
<br />
Here's what a single stack trace looks like:<br />
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBTFFGMEp6UllGN28" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>

<br />
<br />
But a single stack trace is just one data point, not a profile. What if we had 1M samples of this same stack?<br />
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBbTNEX1R3eTJ0VG8" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>
<br />
<br />
Well.. it would look pretty much the same, but if you hover over it will tell you it got 1M samples. It looks the same because we still have 100% the same stack for the whole profile. It's the same profile.<br />
"<b>BUT!</b>" I hear you say, "But, colours?". Yes the colors mean nothing at this point, but will become interesting later. The default colour palate is red and the choice of colors is random, hence the different colour&nbsp;selection changes from run to run. Just forget colors for a second, OK?<br />
Right, next we want to look at a set of samples with a few more stacks:<br />
<span style="background-color: #cccccc; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">
main;0;1;2;3;4;5 1<br />
main;0;1;2;3;4;5;6 2<br />
main;0;1;2;3;4;5;6;7 3<br />
main;0;1;2;3;4;5;6;7;8 4<br />
main;0;1;2;3;4;5;6;7;8;9 5</span><br />
<br />
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBYnIzRWVrUmJ6eE0" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>
<br />
<br />
Now you can also get a feel for what clicking around does and how you zoom in and out.<br />
By now I hope you get the picture for how a bunch of stacks and frequencies look with a simple data sets. Last synthtic example to look at has several root frames and a little more varied stacks. Lets try this:<br />
<span style="background-color: #cccccc; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">
main;a;1;2;3;4;5 1<br />main;c;1;2;3;4;5;6;7 4<br />main;a;1;2;3;4;5;6 2<br />main;c;1;2;3;4;5;6 4<br />
main;c;1;2;3;4;5;6;8 4<br />
main;b;1;2;3;4;5;6;7 3<br />
main;b;1;2;3;4;5;6;8 3<br />
main;b;1;2;3;4;5;6;9 3<br />
main;d;1;2;3;4;5;6;7;8;9 5</span><br />
<br />
And we get this:<br />
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBaHhGQXpaTmJFWk0" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>
<br />
<div>
<span style="background-color: #cccccc; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>
We see here that stacks are sorted alphabetically and ordered from left to right. The ordering has nothing to do with the order in the file. The collapsed stacks format is itself an aggregation with no view on timing. So the order from left to right is only about merging, not time or anything else. We can see that stacks which share a common parent naturally aggregate under that parent. The width of each frame is it's relative <i>total-time</i> share. It's <i>self-time</i>&nbsp;share is it's top exposure, or how much of it is not covered by it's callees, the frames on top of it.<br />
<br />
<h3>
Tree View vs Flames</h3>
Now that we got the hang of this flamy thing, lets take a look at the same profile using 2 presentations. The venerated tree-view and this new hipsterish whatever flame thing. The following is a profile collected using <a href="https://github.com/RichardWarburton/honest-profiler" target="_blank">honest-profiler</a> for a <a href="https://github.com/netty/netty" target="_blank">netty</a> benchmark:<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="https://4.bp.blogspot.com/-LwIWAtR1VSs/WJ3eOSvTwYI/AAAAAAAADe4/NIUkldoo_VEs6VROiMiYfVTZQrJJFYjlACLcB/s1600/Screenshot%2Bfrom%2B2017-02-10%2B17-36-33.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" height="411" src="https://4.bp.blogspot.com/-LwIWAtR1VSs/WJ3eOSvTwYI/AAAAAAAADe4/NIUkldoo_VEs6VROiMiYfVTZQrJJFYjlACLcB/s640/Screenshot%2Bfrom%2B2017-02-10%2B17-36-33.png" width="640" /></a></div>
<br />
<div class="separator" style="clear: both; text-align: center;">
</div>
In typical workflow I step further and further into the hot stack, but this pushes out the big picture out of my view. I would now have to go back up and fold it to see what hides under other hot branches in the tree. It's a familiar and annoying experience if you've ever used a profiler with this kind of view. The problem is that Java class and method names are typically long, and stacks are quite deep. This is a simple application and I quickly run out of room.<br />
Here's the FlameGraph for the same profile (I chose green, because later it makes sense):<br />
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBaTh6XzJtN19xWHM" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>
<br />
<br />
<b><i>NOTE: I made all the flame graphs in this post narrow so they fit the layout. They don't have to be this narrow. You can set the width to whatever you like, I used "--width=700" for the graphs in this post.</i></b><br />
We can see the root frames quickly break out to main activities, with the deep netty stack now visible upfront. We can click and zoom easily. I also find the search ability which colors matching strings useful to highlight class/package participation in the profile. Prominent flat-tops indicate hot leaf methods we might want to look at.<br />
It's perhaps a matter of taste, but I love it. I've been using flame graphs for a while and they are pure genius IMO. I find the image itself is intuitively more approachable, and with the ability to quickly zoom in/out and search I can usually quickly work through a profile without losing sight of the full picture.<br />
So how do you get one?<br />
<br />
<table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; text-align: right;"><tbody>
<tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-gXSadVbcRaM/WKBNkgNHFII/AAAAAAAADf0/P-apIq6oQHUOuYrsrZudHlcl6uirAGgjwCLcB/s1600/bob-wont-hurt-you.gif" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="239" src="https://1.bp.blogspot.com/-gXSadVbcRaM/WKBNkgNHFII/AAAAAAAADf0/P-apIq6oQHUOuYrsrZudHlcl6uirAGgjwCLcB/s320/bob-wont-hurt-you.gif" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">It's Bob! yay?</td></tr>
</tbody></table>
<h3>
Everybody Gets A FlameGraph!</h3>
<div>
Yes, even you poor suckers running JDK 1.3 on Windows XP! I don't <a href="http://psy-lob-saw.blogspot.co.za/2016/02/why-most-sampling-java-profilers-are.html" target="_blank">recommend this method of profiling</a>&nbsp;if you have a more recent JVM, or if your JVM supports AsyncGetCallTrace, but if your deployment is stuck in the past you can still be in on this. This is because ALL JVMs must support JVMTI and AFAIK allow you to hit them with jstack/JVisualVM/hprof. It's a terrible way to profile, there's allot of overhead, and usually you can find a better way, but this is universally available. Collecting a sample via jstack is (a terrible idea) quite easy. Just find the <i>pid</i> of the process you want to profile using <i style="font-weight: bold;">jps </i>and then do something like:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">for i in {1..100}; do</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; jstack &lt;pid&gt; &gt;&gt; iloveoldshit.jstk;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; sleep 0.1;</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">done</span></div>
<div>
And Bob is your relative (which is a good thing apparently).</div>
<div>
Once you've collected a large enough sample for your application you can go on and feed flame graphs:</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cat&nbsp;</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">iloveoldshit</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">.jstk | ./stackcollapse-jstack.pl | ./flamegraph.pl --color=green &gt; jstack-flames.svg</span></div>
<div>
And you get:</div>
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBX1l4aG5OY3BaUG8" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>
<br />
<div>
<br /></div>
<div>
This is the same benchmark from before, but different profile with the safepoint bias. You can compare the two by scrolling up and down. OR you can use FlameGraphs to diff the 2, in a moment.<br />
FlameGraphs supports converting <b>jstack </b>output into collapsed stacks (as above). Efforts exist on GitHub to convert the <b>hprof </b>format&nbsp;which JVisualVM produces (as well as other profilers) into collapsed stack format.<br />
So for all my poor readers, struggling under the oppression of JVMs for which better means to spill out stack samples do not exist, I got your backs, you too can be looking at flame graphs!<br />
But seriously, just move on.<br />
<br />
<h3>
Level Up: AsyncGetCallTrace or JFR</h3>
</div>
<h3>
</h3>
Now, if you want a better profiler, which does not result in bringing your application to safepoint and pausing ALL your threads at each sample AND your are either running a 1.6 or higher JDK (OpenJDK/Oracle/recent Zing) on Linux/Mac/BSD you can use <a href="https://github.com/RichardWarburton/honest-profiler" target="_blank">Honest-Profiler</a> to collect your profile. If you got Oracle JDK 1.7u40 or higher you can use Java Flight Recorder (if you use it in production you need to pay for the licence). These <a href="http://psy-lob-saw.blogspot.co.za/2016/06/the-pros-and-cons-of-agct.html" target="_blank">profilers rely on AsyncGetCallTrace</a> to record the Java stack safely on interrupt(from a signal handler, not at safepoint).<br />
To collect with Honest-Profiler I start my JVM with the following parameter:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">-agentpath:$HONEST_PROFILER_HOME/liblagent.so=host=localhost,port=4242,logPath=$PWD/netty.hpl</span><br />
Then, when I feel the time is right, I can start and stop the profile collection<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo start | nc localhost 4242</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">echo stop | nc localhost 4242</span><br />
<span style="font-family: inherit;">To convert the binary format into collapsed stacks I need to use a helper class in the honest-profiler.jar:</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">java -cp $HONEST_PROFILER_HOME/honest-profiler.jar com.insightfullogic.honest_profiler.ports.console.FlameGraphDumperApplication netty.hpl netty.cstk</span><br />
<a href="https://2.bp.blogspot.com/-9FNZHtyiAdk/WKBasAkv-CI/AAAAAAAADgE/g3HomEZDKhMlUHBJPSxTGBpvXUKafshxACLcB/s1600/larry.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="113" src="https://2.bp.blogspot.com/-9FNZHtyiAdk/WKBasAkv-CI/AAAAAAAADgE/g3HomEZDKhMlUHBJPSxTGBpvXUKafshxACLcB/s200/larry.jpg" width="200" /></a><span style="font-family: inherit;">I can then feed the flamegraph script the collapsed stacks file and get the result which we've already seen.</span><br />
<span style="font-family: inherit;">To <a href="http://isuru-perera.blogspot.co.za/2015/09/java-mixed-mode-flame-graphs.html" target="_blank">convert JFR recordings to flame graphs see this post</a>. But remember children, you must pay Oracle if you use it in production, or Uncle Larry might come for you.</span><br />
<span style="font-family: inherit;"><br /></span>
<br />
<h3>
<span style="font-family: inherit;">Bonus: Diff Profiles!</span></h3>
<div>
A nice benefit of having 2 different profilers produce (via some massaging) a unified format for flame graphs is that we can now diff profiles from 2 profilers. Not something that is generally useful, granted. But diffing profiles is an established capability in many profilers, and is usually used to do a before/after comparison. Flame Graphs support this via the same visualization. Once you have converted your profiles into the collapsed stacks format you can produce a diff file and graph it:</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">./difffolded.pl -n A.cstk B.cstk | ./flamegraph.pl &gt; A-B-diff.svg</span></div>
<div>
Diffing the Honest-Profiler and jstack profiles gives us the following:</div>
<div>
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBY3JuSHBqU3U4ZEE" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>&nbsp;</div>
<div>
<br />
The white squares are not interesting, the red/pink squares highlight the <i>delta of self samples as a percentage of total samples&nbsp;</i>(not so intuitive)<i>.</i>&nbsp;I admit it may seem a tad confusing at first, but at least it draws your eyes to the right places. <a href="http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html" target="_blank">More on differential flame graphs here</a>.<br />
<b>Note</b>:<i> to make this diff work I had to shave off the thread names from the jstack collected collapsed stacks file.</i><br />
<br />
<h3>
Further Bonus: Icicle Graph</h3>
</div>
<div>
Some times the bottleneck is not a particular call stack plateau, but rather a particular method being called from many call sites. This kind of bottleneck will not show well in a flame graph as the different stacks with similar tops will be split and may not stand out. This is really where a flat profile is great, but we can also flip the flame graph view to highlight the top method merging:</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">cat netty.cstk | ./flamegraph.pl --reverse --invert --color=green &gt; netty-icicles.svg</span></div>
<div>
<span style="font-family: inherit;">I've filtered the stacks to show only a relevant portion:</span></div>
<div>
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBY2ZyQ3pSU0g5a28" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object><br />
This is not dissimilar to functionality offered by other profiler GUIs which allow the drill down direction to start from hot methods and into their callers in a tree view presentation.<br />
<br />
<h3>
Level UP++: Java Perf Flame Graphs FTW!</h3>
</div>
<div>
If you are so fortunate as to:</div>
<div>
<ol>
<li>Be running OpenJDK/Oracle 1.8u60 or later(this functionality is coming to Zing in a near future release, fingers crossed)</li>
<li>Running on Linux</li>
<li>Got permissions to make this run</li>
</ol>
You can get amazing visibility into your system by using a combination of:</div>
<div>
<ol>
<li>Java with: -XX:+PreserveFramePointer (also recommended -XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints so unfolded frame are more accurate)</li>
<li><a href="https://github.com/jrudolph/perf-map-agent/" target="_blank">perf-map-agent</a>: &nbsp;This attachable agent dumps a symbol mapping file for all runtime generated code in the JVM, enabling perf to correctly resolve addresses to methods. You'll need to clone and build.</li>
<li>perf: You'll need permissions and you'll need to install it. I assume you are root of you own machine for simplicity.</li>
</ol>
With the above working you can collect a perf profile of your Java process(by itself or as part of whole system). This results in a <i>perf.data</i>&nbsp;file and a <i>perf-&lt;pid&gt;.map</i>&nbsp;file in your /tmp folder. You can then proceed to generate a collapsed stack profile from that file, the simplest way to get this going is by using a script packed with <i>perf-map-agent</i>:</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">perf-java-flames &lt;pid&gt;</span></div>
<div>
<span style="font-family: inherit;">This will ask for password as it needs to sudo a few things. Be the sudo you want to see in the world. After a suspenseful wait of 15 seconds you'll get this:</span><br />
<div>
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBU2FWRWhRWFNPN2c" type="image/svg+xml">
  Please Use modern Browser(e.g. recent chrome?) to see this SVG!
</object>
</div>
<i style="font-family: inherit;">Note: Netty deploys it's native lib into tmp, loads it and deletes it, which means perf gets lost looking for it. I deleted it from the benchmarks jar and loaded it directly using LD_LIBRARY_PATH to resole this visibility issue. It doesn't make a huge difference, but in case you try this out.</i><br />
<span style="font-family: inherit;"><br /></span>
<span style="font-family: inherit;">The green frames are Java, and the rest are all the magic which happens to help Java along. Here's what happened:</span><br />
<br />
<ul>
<li>Red frames are C library or Kernel code. We can see that the socket writes in the original profile actually go into native land. We now have further visibility down the hole. Importantly this illustrates where hot Java methods are in fact not Java methods at all and so looking at their Java code for optimisation ops is futile.</li>
<li>Yellow frames are C++. We can see the call chain leading into the interpreter and ultimately into compiled Java code.</li>
<li>Green frames are Java. BUT if you compare the previously presented profiles will this one you will notice there are some intermediate frames missing here. This is because the frames in this profile are "real" frames, or rather they map to stack frame. Inlined methods in Java do not have their own stack frames, so we can't see them (for now, we'll sort this out in a second). Further more, the keen observer will notice the familiar "Thread.run" bottom of the stack is missing, replaced by the "interpreter". As is often the case, the run method did not get compiled in this benchmark so it is not a proper compiled method for which we have a mapping. Methods in the interpreter are opaque in this profile.</li>
<li>Some stacks are broken, which can be confusing. In the example above we can see the 13.8 unknown chunk which leads to some JVM activities, but also to some Java code. More on that later.</li>
</ul>
So, it would seem that we have gained something in visibility into the native/OS/JVM CPU utilization, but lost allot of information we had in the Java side. When is this still useful:<br />
<br />
<ul>
<li>This profile is super useful if you are writing Netty and trying to workout which system calls you end up with from your JNI code, or where time is spent in that code (netty implements it's own native epoll selector, very cool). If you are writing an application which utilizes JNI libraries this profile will give you visibility across the divide. The alternative here would be to use 2 profilers and try and correlate them. Solaris Studio also offers some help here, I will one day write a post on Solaris Studio.</li>
<li>This in not a good example of a profile dominated by JVM threads, but in many profiles the GC activity will show up. This is very useful, as GC and compiler CPU utilization can get in the way of application threads using the available CPU. A Java only profiler leaves you to correlate GC/compilation logs and application profile to figure out who ate the pie. It's also an interesting view into which part of the GC is to blame.</li>
<li>Some JVM <a href="https://en.wikipedia.org/wiki/Intrinsic_function" target="_blank">intrinsics</a> are confusing to AsyncGetCallTrace, and invisible to safepoint profilers. The biggest culprit I see is array copy. Array copies will show up as failed samples on AGCT profilers (unless, like JMC they just fail to tell you about failed samples all together). They show up in this profile (search above for <i>arraycopy</i>), but only a tiny bit.</li>
<li>This profile can be collected system wide, allowing you to present a much wider picture and expose machine wide issues. This is important when you are looking at machine level analysis of your application to improve configuration/setup.</li>
<li>In depth view of OS calls can inform your configuration.</li>
</ul>
<blockquote class="tr_bq">
<a href="https://4.bp.blogspot.com/-vEr3dnMD914/WKLuxp1nXuI/AAAAAAAADgc/T0Bmu3C_4dYCsxfmnLF6jY2duQvCbrjzgCLcB/s1600/cat-in-hat.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="320" src="https://4.bp.blogspot.com/-vEr3dnMD914/WKLuxp1nXuI/AAAAAAAADgc/T0Bmu3C_4dYCsxfmnLF6jY2duQvCbrjzgCLcB/s320/cat-in-hat.jpg" width="224" /></a><br />
<blockquote class="tr_bq" style="text-align: center;">
<i>'look at me!&nbsp;</i><i>look at me now!' said the cat.</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>'with a cup and a cake&nbsp;</i><i>on the top of my hat!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>I can hold up TWO books!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>I can hold up the fish!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>and a little toy ship!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>and some milk on a dish!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>and look!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>I can hop up and down on the ball!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>but that is not all!</i></blockquote>
<blockquote class="tr_bq" style="text-align: center;">
<i>oh, no. T</i><i>hat is not all...</i></blockquote>
</blockquote>
<br />
<br />
<h3>
Bonus: Inlined Frames! Threads! COLOR!</h3>
We can win back the inlined frames information by asking perf-map-agent to create a more detailed map file with inlining data. This leads to larger map files, but should be worth it.<br />
You can further tweak the command line to color kernel frames differently and control sample duration and frequency. And while we're a-tweakin' lets also have threads info.<br />
Here's what you run:</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">PERF_COLLAPSE_OPTS="--kernel --tid" PERF_RECORD_FREQ=99 PERF_RECORD_SECONDS=10 PERF_MAP_OPTIONS=unfoldall perf-java-flames &lt;pid&gt;</span></div>
<div>
And the graph now looks like this:<br />
<div>
<object data="https://drive.google.com/uc?export=view&amp;id=0B4jDFCGuuSqBU04yZkU1cF9ZR2s" type="image/svg+xml">
  Please Use modern Browser (e.g. recent chrome?) to see this SVG!
</object>
</div>
<br />
<br />
<ul>
<li>The Java frames are now green and aqua. Aqua frames are inlined frames and green are "real". This information is not presented at all by most profilers, and is pretty inaccessible in others. Here we can instantly see some interesting inlining challenges in the tall towers of same sized frames. The compiler inlines through many, but maybe eventually gives up, maybe there's something to be won by simplifying the abstraction here?</li>
<li>Thread id is added as a base frame. This is helpful in this particular example because there are only 2 interesting threads and I very much want to see this split. It also helps bring back some broken stacks into the fold. Now I can tell these frames belong to the Netty epoll thread. Yay.</li>
<li>Orange frames are kernel frames.</li>
<li>Having the thread id highlights that the none Java frames on the left are from a variety of threads. If we had more GC/Compiler work happening this may become interesting.</li>
<li>Profiling a large application with thread pools this separation by thread may not be what you want... but sometimes it is very helpful, like above. In this benchmark I have a thread generating load and a thread I want to profile, so telling them apart works great. At the moment there's no mapping of threads to thread names, but in future we may be able to easily group thread pools for more meaningful views.</li>
</ul>
<h3>
Bonus: Hack It All Up</h3>
<div>
There's very little code in perf-map-agent, and the scripts would take you 5 minutes to read through. You don't have to use the scripts, you can write your own. You can add or enhance features, it's easy to participate or customize. Dig in, have fun :-)</div>
<div>
The FlameGraph scripts are nice and tidy, and the pipeline separation of [profile -&gt; collapsed stacks -&gt; graph] means you can read through them and tweak as you like the bits you care about without caring too much about the rest. While working on this post I played with the diff presentation a bit. It was my first ever interaction with Perl, and I'm not so very bright, and I managed to get what I wanted. Surely someone as fine as yourself can do better.</div>
<div>
If you look at Brenden's updates page you'll see many many people are jumping in and tweaking and sharing and making funky things. Go for it!</div>
<div>
<br /></div>
<h3>
Summary And Credits</h3>
<div>
So you can have flame graphs, all of you. And you can feed these with inputs from several sources, each with their own set of pros and cons. It makes a great tool in your tool box and may give you that extra perspective you are missing in your profiling.</div>
<div>
There's a few people who deserve mention in the context of the tools above, look them up, they all helped make it happen:</div>
<div>
<ul>
<li><a href="http://brendangregg.com/" target="_blank">Brendan Gregg</a>: FlameGraphs proud daddy. Brendan has written allot about FlameGraphs, work through his posts and you'll learn plenty.</li>
<li><a href="https://github.com/jrudolph" target="_blank">Johannes Rudolph</a>: Author and maintainer of perf-map-agent.</li>
<li><a href="https://github.com/tjake" target="_blank">Jake Lucianni</a>: Contributed flamegraphs support for inlined frames.</li>
<li><a href="https://github.com/RichardWarburton" target="_blank">Richard Warburton</a>: Author and maintainer of honest-profiler.</li>
</ul>
Thanks for reading :-) next up some JVM profile analysis</div>
</div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'><span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html' itemprop='url'/>
<a class='timestamp-link' href='http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2017-02-14T17:14:00Z'>17:14:00</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html#comment-form' onclick=''>
8 comments:
    </a>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-1797904270'>
<a href='https://www.blogger.com/post-edit.g?blogID=5171098727364395242&postID=1641272956353975323&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1641272956353975323&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1641272956353975323&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1641272956353975323&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1641272956353975323&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=1641272956353975323&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html' size='medium' width='300' annotation='inline'/></div>
</div>
<span class='post-backlinks post-comment-link'>
</span>
</div>
<div class='post-footer-line post-footer-line-2'><span class='post-labels'>
Labels:
<a href='http://psy-lob-saw.blogspot.com/search/label/AsyncGetCallTrace' rel='tag'>AsyncGetCallTrace</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/FlameGraphs' rel='tag'>FlameGraphs</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JVM' rel='tag'>JVM</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/perf' rel='tag'>perf</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/perf-map-agent' rel='tag'>perf-map-agent</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Profiling' rel='tag'>Profiling</a>
</span>
</div>
<div class='post-footer-line post-footer-line-3'><span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Tuesday, 20 December 2016</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='https://2.bp.blogspot.com/-JS28cnrORow/UpcF6K3jqaI/AAAAAAAAAXg/jpGXkSvzU7QZo-xLAIar6RwlGky-Pr8igCPcB/s200/ShelbyBlondell-RoadToHell.jpeg' itemprop='image_url'/>
<meta content='5171098727364395242' itemprop='blogId'/>
<meta content='3960396435122440504' itemprop='postId'/>
<a name='3960396435122440504'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://psy-lob-saw.blogspot.com/2016/12/what-is-lazyset-putordered.html'>What do Atomic*::lazySet/Atomic*FieldUpdater::lazySet/Unsafe::putOrdered* actually mean?</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-3960396435122440504' itemprop='articleBody'>
<table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody>
<tr><td style="text-align: center;"><a href="https://2.bp.blogspot.com/-JS28cnrORow/UpcF6K3jqaI/AAAAAAAAAXg/jpGXkSvzU7QZo-xLAIar6RwlGky-Pr8igCPcB/s1600/ShelbyBlondell-RoadToHell.jpeg" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="200" src="https://2.bp.blogspot.com/-JS28cnrORow/UpcF6K3jqaI/AAAAAAAAAXg/jpGXkSvzU7QZo-xLAIar6RwlGky-Pr8igCPcB/s200/ShelbyBlondell-RoadToHell.jpeg" width="200" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Paved with well intended definitions it is.</td></tr>
</tbody></table>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">lazySet/putOrdered (or an <b>ordered store</b>) was added as a bit of a rushed/non-commital afterthought after the JMM was done, so it's description is subject to many debates on the mailing lists, stack overflow and watercoolers the world over. This post merely tries to provide a clear definition with references to relevant/reputable sources.</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">
</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Definition:</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><b>An ordered store is a <u>weakened volatile store[2][5]</u>. It prevents preceding stores and loads from being reordered with the store[1][3][6], but does not prevent subsequent stores and loads from being reordered with it[2][4].</b></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">If there was a JMM cookbook entry for </span><b style="font-family: 'helvetica neue', arial, helvetica, sans-serif;">ordered store</b><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"> defining it with barriers in mind it would seem that the consensus is that </span><b style="font-family: 'helvetica neue', arial, helvetica, sans-serif;">ordered stores</b><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"> are preceded by a StoreStore AND a LoadStore barrier[4][6].</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><b style="font-family: 'helvetica neue', arial, helvetica, sans-serif;">Ordered store </b><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">is practically the same as a C++ memory_release_store[5][7].</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">
</span></pre>
<div style="text-align: right;">
</div>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">References:</span><span style="font-family: inherit;"><span style="font-family: inherit;">
</span><b><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">[1] Original bug:</span></b></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: inherit;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: inherit;">"</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: medium;">lazySet provides a preceding store-store barrier (which is either a no-op or very cheap on current platforms), but no store-load barrier</span><span style="font-family: inherit;">"</span></span><span style="font-family: inherit;">
</span><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">See here: <a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6275329" style="color: #663366;">http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6275329</a>
</span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="font-family: inherit; white-space: pre-wrap;">
</span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; white-space: pre-wrap;"><b>[2] java.util.concurrent docs</b>:</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: inherit;"><span style="white-space: pre-wrap;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: inherit;">"</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: medium;">lazySet has the memory effects of writing (assigning) a volatile variable except that it permits reorderings with subsequent (but not previous) memory actions that do not themselves impose reordering constraints with ordinary non-volatile writes.</span><span style="font-family: inherit;">"</span></span><span style="font-family: inherit;">
</span><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">See here: </span></span><span style="color: #663366; font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; white-space: pre-wrap;"><a href="https://docs.oracle.com/javase/8/docs/api/?java/util/concurrent/package-summary.html" style="color: #663366; white-space: pre-wrap;">https://docs.oracle.com/javase/8/docs/api/?java/util/concurrent/package-summary.html</a></span><span style="font-family: inherit; white-space: pre-wrap;"><span style="font-family: inherit;">
</span></span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: inherit;">
</span></pre>
<div class="separator" style="clear: both; text-align: center;">
<a href="https://4.bp.blogspot.com/-rv55WNsVk04/WFjrgAOjSBI/AAAAAAAADW0/EarQw_TM59Yhbn374tg7SI9KNm6yeHv-wCLcB/s1600/cookbook.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="212" src="https://4.bp.blogspot.com/-rv55WNsVk04/WFjrgAOjSBI/AAAAAAAADW0/EarQw_TM59Yhbn374tg7SI9KNm6yeHv-wCLcB/s320/cookbook.jpg" width="320" /></a></div>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: inherit;"><span style="white-space: pre-wrap;"><b><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">[3] JMM cookbook:</span></b><span style="font-family: inherit;"> </span><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Defining barriers meaning here: </span></span><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif; white-space: pre-wrap;"><a href="http://g.oswego.edu/dl/jmm/cookbook.html">http://g.oswego.edu/dl/jmm/cookbook.html</a></span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><b style="white-space: pre-wrap;"><span style="font-family: inherit;">
</span></b></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><b style="white-space: pre-wrap;">[4] concurrency-interest Q&amp;A with Doug Lea, October 2011</b><span style="white-space: pre-wrap;">:</span><span style="white-space: pre-wrap;"><span style="font-family: inherit;">
</span></span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; white-space: pre-wrap;"><span style="font-family: inherit;">"[Ruslan]:</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: medium;">... If it happens (== we see spin-wait loop finished) -- does it mean,that all writes preceding lazySet are also done, committed, and visible to thread 2, which finished spin-wait loop?
</span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: inherit;"><span style="white-space: pre-wrap;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: medium;">[Doug]: Yes, although technically, you cannot show this by reference to the Synchronization Order in the current JLS.
...
lazySet basically has the properties of a TSO store</span><span style="font-family: inherit;">"</span></span><span style="font-family: inherit;">
</span><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">See here: </span></span><a href="http://cs.oswego.edu/pipermail/concurrency-interest/2011-October/008296.html" style="color: #663366; white-space: pre-wrap;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">http://cs.oswego.edu/pipermail/concurrency-interest/2011-October/008296.html</span></a><span style="white-space: pre-wrap;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">
</span><b style="font-family: inherit;"><u>
</u></b></span></span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="width: 50em;"><span style="font-family: inherit;"><span style="white-space: pre-wrap;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">The discussion is REALLY worth reading, involving Hans, Doug, Vitaly, Ruslan and other such respectable members of this excellent mailing list. Go on, I'll wait.

The discussion on that thread concludes the following is required:</span><span style="font-family: inherit;">
</span></span><span style="white-space: pre-wrap;">...
<span style="font-family: inherit;">LoadStore + </span>StoreStore
st [Y],X // store X into memory address Y
...
</span><span style="white-space: pre-wrap;">
</span></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Outcome: Stores before and after are now prevented from floating across the barrier. Loads before the barrier are also prevented from floating down. Later loads are free to float up. Note that <b>st</b> may in theory be delayed indefinitely, certainly other loads and stores are allowed to float up between it and the barrier.</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: inherit;">
</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><b>[5] concurrency-interest Q&amp;A with Aleksey Shipilev, May 2016</b>:</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">"</span>putOrdered is a release in disguise, most of the C++11 std::atomic(...,</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">mem_order_release) reasoning applies here."</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">"</span>acquire/release are the relaxations from the usual volatile</span></pre>
<pre style="white-space: pre-wrap;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">rules -- while producing happens-before-s, they drop from total
</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">synchronization order, thus breaking sequential consistency."</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: inherit;">
</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">And adds some fine examples:</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">"Safe publication still works:</span></pre>
<pre style="white-space: pre-wrap;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">
                       int x; volatile int y;
-----------------------------------------------------------------------
    put(x, 1);                   |  r1 = get{Acquire|Volatile}(y);
    put{Release|Volatile}(y, 2); |  r2 = get(x);

(r1, r2) = (2, 0) is forbidden.

But anything trickier that requires sequential consistency fails. IRIW
fails, because no consistent write order observed by all threads. Dekker
fails, because release stores followed by loads may or may not be
visible in program order:

                     volatile int x; volatile int y;
-----------------------------------------------------------------------
    putRelease(x, 1);            |    putRelease(y, 1);
    r1 = getAcquire(y);          |    r2 = getAcquire(x);

(r1, r2) = (0, 0) is allowed. Forbidden if all ops are volatile.


Safe construction still <b>does not work</b> (even for volatiles!):

                                A global;
-----------------------------------------------------------------------
    A a = &lt;alloc&gt;;                  |  A a = global;
    put{Release|Volatile}(a.x, 1);  |  r1 = get{Acquire|Volatile}(a.x);
    global = a;                     |

(r1) = (0) is allowed."</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">See here: <a href="http://cs.oswego.edu/pipermail/concurrency-interest/2016-May/015104.html">http://cs.oswego.edu/pipermail/concurrency-interest/2016-May/015104.html</a></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">
</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><b><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">[6] </span>concurrency-interest Q&amp;A with Aleksey Shipilev, March 2016:</span></b></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">"</span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&gt;<i> int a, b;</i></span></pre>
<pre style="white-space: pre-wrap;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&gt;<i> 
</i>&gt;<i> boolean tryLock() {
</i>&gt;<i>     UNSAFE.putOrdered(a, 1); // Declare intent.
</i>&gt;<i> 
</i>&gt;<i>     // No StoreLoad here as store is not volatile.
</i>&gt;<i> 
</i>&gt;<i>     if (UNSAFE.getVolatile(b) == 1)) {
</i>&gt;<i>         // Reset intent and return false;
</i>&gt;<i>     }
</i>&gt;<i> 
</i>&gt;<i>     return true;
</i>&gt;<i> }
</i>
Even in the naive barrier interpretation that usually gives stronger
answers, you have:

 [LoadStore|StoreStore]
 a = 1;

 r1 = b;
</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"> [LoadLoad|LoadStore]</span><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">"</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">See here: <a href="http://cs.oswego.edu/pipermail/concurrency-interest/2016-March/015037.html">http://cs.oswego.edu/pipermail/concurrency-interest/2016-March/015037.html</a></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">
</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><b><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">[7] C++ memory_order_release definition:</span></b></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">"<span style="background-color: white; line-height: 14.08px;">A store operation with this memory order performs the&nbsp;</span><i style="background-color: white; line-height: 14.08px;">release operation</i><span style="background-color: white; line-height: 14.08px;">: no reads or writes in the current thread can be reordered after this store. All writes in the current thread are visible in other threads that acquire the same atomic variable (see&nbsp;</span><a href="http://en.cppreference.com/w/cpp/atomic/memory_order#Release-Acquire_ordering" style="background: none rgb(255, 255, 255); color: #0b0080; line-height: 14.08px; text-decoration: none;">Release-Acquire ordering</a><span style="background-color: white; line-height: 14.08px;">&nbsp;below) and writes that carry a dependency into the atomic variable become visible in other threads that consume the same atomic (see&nbsp;</span><a href="http://en.cppreference.com/w/cpp/atomic/memory_order#Release-Consume_ordering" style="background: none rgb(255, 255, 255); color: #0b0080; line-height: 14.08px; text-decoration: none;">Release-Consume ordering</a><span style="background-color: white; line-height: 14.08px;">&nbsp;below).</span>"</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">See here: <a href="http://en.cppreference.com/w/cpp/atomic/memory_order">http://en.cppreference.com/w/cpp/atomic/memory_order</a></span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"><span style="font-family: &quot;helvetica neue&quot; , &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">Many thanks to <a href="https://twitter.com/shipilev" target="_blank">A. Shipilev</a>, <a href="https://twitter.com/mjpt777" target="_blank">M. Thompson</a>, <a href="https://twitter.com/switchology" target="_blank">D. Lawrie</a> and <a href="https://twitter.com/dj_begemot" target="_blank">C. Ruslan</a>  for reviewing, any remaining errors are their own and they shall be most severely reprimanded for them.</span></pre>
<pre class="bz_comment_text" id="comment_text_3" style="white-space: pre-wrap; width: 50em;"></pre>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'><span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://psy-lob-saw.blogspot.com/2016/12/what-is-lazyset-putordered.html' itemprop='url'/>
<a class='timestamp-link' href='http://psy-lob-saw.blogspot.com/2016/12/what-is-lazyset-putordered.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2016-12-20T08:33:00Z'>08:33:00</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://psy-lob-saw.blogspot.com/2016/12/what-is-lazyset-putordered.html#comment-form' onclick=''>
9 comments:
    </a>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-1797904270'>
<a href='https://www.blogger.com/post-edit.g?blogID=5171098727364395242&postID=3960396435122440504&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=3960396435122440504&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=3960396435122440504&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=3960396435122440504&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=3960396435122440504&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=3960396435122440504&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://psy-lob-saw.blogspot.com/2016/12/what-is-lazyset-putordered.html' size='medium' width='300' annotation='inline'/></div>
</div>
<span class='post-backlinks post-comment-link'>
</span>
</div>
<div class='post-footer-line post-footer-line-2'><span class='post-labels'>
Labels:
<a href='http://psy-lob-saw.blogspot.com/search/label/Concurrency' rel='tag'>Concurrency</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Java' rel='tag'>Java</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JMM' rel='tag'>JMM</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/lazySet' rel='tag'>lazySet</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Memory%20model' rel='tag'>Memory model</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/putOrdered' rel='tag'>putOrdered</a>
</span>
</div>
<div class='post-footer-line post-footer-line-3'><span class='post-location'>
</span>
</div>
</div>
</div>
</div>

          </div></div>
        

          <div class="date-outer">
        
<h2 class='date-header'><span>Tuesday, 13 December 2016</span></h2>

          <div class="date-posts">
        
<div class='post-outer'>
<div class='post hentry' itemprop='blogPost' itemscope='itemscope' itemtype='http://schema.org/BlogPosting'>
<meta content='https://2.bp.blogspot.com/-cTILpnpChCU/WE-laCiA4LI/AAAAAAAADVk/r4vcoxNadHcH3NTItBg8wTL9LfvN8HD2QCLcB/s1600/fire%2Blab3.jpg' itemprop='image_url'/>
<meta content='5171098727364395242' itemprop='blogId'/>
<meta content='6248079574454576164' itemprop='postId'/>
<a name='6248079574454576164'></a>
<h3 class='post-title entry-title' itemprop='name'>
<a href='http://psy-lob-saw.blogspot.com/2016/12/linked-array-queues-part-2-spsc.html'>Linked Array Queues, part 2: SPSC Benchmarks</a>
</h3>
<div class='post-header'>
<div class='post-header-line-1'></div>
</div>
<div class='post-body entry-content' id='post-body-6248079574454576164' itemprop='articleBody'>
<a href="https://github.com/JCTools/JCTools" target="_blank">JCTools</a>&nbsp;has a bunch of&nbsp;<a href="https://github.com/JCTools/JCTools/tree/master/jctools-benchmarks" target="_blank">benchmarks</a>&nbsp;we use to stress test the queues and evaluate optimizations. <br />
<div class="separator" style="clear: both; text-align: center;">
<a href="https://2.bp.blogspot.com/-cTILpnpChCU/WE-laCiA4LI/AAAAAAAADVk/r4vcoxNadHcH3NTItBg8wTL9LfvN8HD2QCLcB/s1600/fire%2Blab3.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="https://2.bp.blogspot.com/-cTILpnpChCU/WE-laCiA4LI/AAAAAAAADVk/r4vcoxNadHcH3NTItBg8wTL9LfvN8HD2QCLcB/s1600/fire%2Blab3.jpg" /></a></div>
These are of course not 'real' workloads, but serve to highlight imperfections and opportunities. While it is true that an optimization might work in a benchmark but not in the real world, a benchmark can work as a demonstration that there are at least circumstances in which it does work. All measurement is imperfect, but not as imperfect as claims made with no fucking evidence whatsoever, so here goes.<br />
<div>
How do these linked-array queues fare in the benchmarks? what can we learn here?</div>
<div>
The&nbsp;<a href="http://psy-lob-saw.blogspot.com/2016/10/linked-array-queues-part-1-spsc.html" target="_blank">linked array queues</a>&nbsp;are a hybrid of the array and linked queues. So it seems reasonable that we should compare them to both SpscArrayQueue and SpscLinkedQueue. We should also consider how the queues differ and see if we can flush out the differences via the benchmarks.<br />
If you crack under the pressure of boring details, skip to the summary, do not stop at interlude, do not collect a cool drink or get praise, just be on yer fuckin' merry way.<br />
<br />
<h3>
Setup:</h3>
Benchmarks are run on a quiet server class machine:
<br />
<ul>
<li>Xeon processor(Intel(R) Xeon(R) CPU E5-2670 v3 @ 2.30GHz): 2 CPUs x 12 cores x 2 threads (HT)</li>
<li>CentOS</li>
<li>Oracle JDK8u101</li>
<li>All benchmarks are run taskset to cores on the same numa node, but such that threads cannot share the same physical core.</li>
<li>Turbo boost is off, the scaling governor is userspace and the frequency is fixed.</li>
<li>The&nbsp;<a href="https://github.com/JCTools/JCTools/tree/master/jctools-core/src/main/java/org/jctools/queues" target="_blank">code is on github</a></li>
</ul>
</div>
<h3>
Throughput benchmark: background and method</h3>
<div>
A throughput benchmark for queues is a tricky fucker. In particular the results change meaning depending on the balance between consumer and producer:</div>
<div>
<ul>
<li>If the consumer is faster than the producer we are measuring empty queue contention (producer/consumer hitting the same cache line for elements in the queue, perhaps sampling each other index). Empty queues are the expected state for responsive applications.</li>
<li>If the producer is faster than the consumer we are measuring full queue contention, which may have similar issues. For some queues which optimize for the healthy assumption that queues are mostly empty this may be a particularly bad place to be.</li>
<li>If the producer and consumer are well balanced we are testing a streaming use case which offers the most opportunities for progress for both consumer and producer. This should yield the best performance, but for most applications&nbsp;<b>may not be a realistic scenario at all</b>.</li>
</ul>
</div>
<div>
<div class="separator" style="clear: both; text-align: center;">
<a href="https://1.bp.blogspot.com/-xgg8JAnY0lA/WE-lmM3AuzI/AAAAAAAADVo/F8AgmSZqAyk8BtranxsXdhY1-NbGvTimQCLcB/s1600/lab%2Bfire.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="https://1.bp.blogspot.com/-xgg8JAnY0lA/WE-lmM3AuzI/AAAAAAAADVo/F8AgmSZqAyk8BtranxsXdhY1-NbGvTimQCLcB/s1600/lab%2Bfire.jpg" /></a></div>
The JCTools throughput benchmark&nbsp;<b>does not resolve these issues</b>. It does however report results which give us an idea of poll/offer failure rates which are in turn indicative of which state we find ourselves in.<br />
A further challenge in managed runtime environments, which is unrelated to queues, is that garbage generating benchmarks will have GC state accumulate across measurement iterations. The implication is that each iteration is measuring from a different starting state. Naturally occurring GCs will leave the heap in varying states depending on the point at which they hit. We can choose to either embrace the noise in the measurement as an averaging of the cost/overhead of garbage or allocate a large enough heap to accommodate a single iteration worth of allocation and force a full GC per iteration, thus resetting the state per iteration.&nbsp;<b>The benchmarks below were run with 8g heap and a GC cycle between iterations.</b><br />
The&nbsp;<a href="https://github.com/JCTools/JCTools/blob/master/jctools-benchmarks/src/main/java/org/jctools/jmh/throughput/QueueThroughputBackoffNone.java" target="_blank">benchmark I run here is the no backoff version of the throughput benchmark</a>&nbsp;where failure to offer/poll makes no attempt at waiting/yielding/tapping of foot and just tries again straight away. This serves to maximize contention and is not a recipe for happiness in real applications.<br />
JMH parameters common to all runs below:
<br />
<ul>
<li>-gc true -&gt; GC cycle between iterations</li>
<li>-jvmArgs="-Xmx8g -Xms8g" -&gt; 8g heap</li>
<li>-i 10 &nbsp;-r 1 -&gt; 10 measurement iterations, 1 second each</li>
<li>-wi 20&nbsp;-w 1 -&gt; 20 warmup iterations, 1 second each</li>
<li>-f 5 -&gt; five forks each to expose run to run variance</li>
</ul>
</div>
<div>
<br /></div>
<div>
<h3>
Throughput benchmark: baseline(JMH params: -bm thrpt -tu us)</h3>
Here's some baseline results, note the unit is ops/us equal to millions of ops per second:<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">SpscArrayQueue (128k capacity)</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed &nbsp; 0.005 &#177; &nbsp;0.008 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersMade &nbsp; 252.201 &#177; &nbsp;1.649 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed &nbsp; &nbsp;0.009 &#177; &nbsp;0.008 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade &nbsp; &nbsp;252.129 &#177; &nbsp;1.646 &nbsp;ops/us</span></div>
<div>
<br /></div>
<div>
So the SpscArrayQueue is offering great throughput, and seems pretty well balanced with failed offers/polls sort of cancelling out and low compared to the overall throughput.</div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">SpscLinkedQueue</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersFailed &nbsp; &nbsp; &#8776; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">offersMade &nbsp; &nbsp;14.711 &#177; &nbsp;5.897 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsFailed &nbsp; 12.624 &#177; &nbsp;8.281 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">pollsMade &nbsp; &nbsp; 14.710 &#177; &nbsp;5.896 &nbsp;ops/us</span></div>
</div>
<div>
<br /></div>
<div>
For the SpscLinkedQueue we have no failed offers, since it's an unbounded queue. We do see a fair amount of failed polls. We expect the polls to be faster than the offers as offering pays for allocation of nodes on each element (24b overhead per element), while the poll simply leaves it to the GC to toss it all away.</div>
<div>
With this baseline we would expect linked arrays queues performance to be somewhere between the 2 data points above. Unlikely to hit the highs of the preallocated array queue, but hopefully much better than a linked queue.<br />
<br /></div>
<div>
<h3>
Throughput benchmark: growable</h3>
<div>
So assuming we let it grow to 128k, how does the SpscGrowableArrayQueue perform in this benchmark and how much does the initial size impact the performance? CNK here is the <b>initial</b> buffer size. The buffer will double in size when offer fills up a buffer until we hit the max size buffer.</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;CNK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Score &nbsp; &nbsp;Error &nbsp; Units</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 offersFailed &nbsp; &nbsp;0.006 &#177; &nbsp;0.006 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 offersMade &nbsp; &nbsp;183.720 &#177; &nbsp;0.450 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 pollsFailed &nbsp; &nbsp; 0.003 &#177; &nbsp;0.001 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 pollsMade &nbsp; &nbsp; 183.592 &#177; &nbsp;0.450 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 offersFailed &nbsp; &nbsp;0.003 &#177; &nbsp;0.006 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 offersMade &nbsp; &nbsp;184.236 &#177; &nbsp;0.336 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 pollsFailed &nbsp; &nbsp; 0.003 &#177; &nbsp;0.001 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 pollsMade &nbsp; &nbsp; 184.107 &#177; &nbsp;0.336 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K offersFailed &nbsp; &nbsp;0.001 &#177; &nbsp;0.003 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K offersMade &nbsp; &nbsp;183.113 &#177; &nbsp;1.385 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K pollsFailed &nbsp; &nbsp; 0.003 &#177; &nbsp;0.001 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K pollsMade &nbsp; &nbsp; 182.985 &#177; &nbsp;1.385 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K offersFailed &nbsp; &nbsp;0.007 &#177; &nbsp;0.006 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K offersMade &nbsp; &nbsp;181.388 &#177; &nbsp;5.380 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K pollsFailed &nbsp; &nbsp; 0.004 &#177; &nbsp;0.001 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K pollsMade &nbsp; &nbsp; 181.259 &#177; &nbsp;5.380 &nbsp;ops/us</span></div>
<br /></div>
<div>
<ul>
<li>Under constant streaming pressure the Growable queue will keep growing until either full sized buffer is allocated (very likely) or a smaller buffer in which the throughput is sustainable is found (unlikely for this benchmark as all it takes is a single spike). If that was the case we would have no failing offers. Either way we expect transition to the last buffer to be a short phase after which the algorithm is very similar to SpscArrayQueue and no further allocations happen. The number of resizing events is small, as the buffer doubles each time (so log2(capacity/initial size), e.g. for initial capacity 16k: 16k -&gt; 32k -&gt; 64k -&gt; 128k).</li>
<li>You may consider the slow down from&nbsp;SpscArrayQueue large at roughly 25%, but I don't think it too bad considering that with the throughputs in question we are looking at costs in the single digit nanoseconds where every extra instruction is going to show up (back of envelope: 250 ops/us -&gt; ~4ns per offer/poll vs 180 ops/us -&gt; ~5ns. 1ns = ~3 cycle ~= 12 instructions or 1 L1 load).</li>
</ul>
</div>
<div>
<h3>
Throughput benchmark: chunked</h3>
<div>
<div>
For Chunked we see the expected increase in throughput as we increase the chunk size (CNK is the <b>fixed chunk size</b>, the max size is 128K):</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;CNK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Score &nbsp; &nbsp;Error &nbsp; Units</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 offersFailed &nbsp; &nbsp; &nbsp;&#8776; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 offersMade &nbsp; &nbsp; 43.665 &#177; &nbsp;0.892 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 pollsFailed &nbsp; &nbsp; 9.160 &#177; &nbsp;0.519 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 pollsMade &nbsp; &nbsp; &nbsp;43.665 &#177; &nbsp;0.892 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 offersFailed &nbsp; &#8776; 10&#8315;&#8308; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 offersMade &nbsp; &nbsp;151.473 &#177; 18.786 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 pollsFailed &nbsp; &nbsp; 0.380 &#177; &nbsp;0.331 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 pollsMade &nbsp; &nbsp; 151.443 &#177; 18.778 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K offersFailed &nbsp; &nbsp;0.309 &#177; &nbsp;0.375 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K offersMade &nbsp; &nbsp;149.351 &#177; 14.102 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K pollsFailed &nbsp; &nbsp; 0.112 &#177; &nbsp;0.125 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K pollsMade &nbsp; &nbsp; 149.314 &#177; 14.120 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K offersFailed &nbsp; &#8776; 10&#8315;&#8312; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K offersMade &nbsp; &nbsp;175.408 &#177; &nbsp;1.563 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K pollsFailed &nbsp; &nbsp; 0.038 &#177; &nbsp;0.031 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K pollsMade &nbsp; &nbsp; 175.394 &#177; &nbsp;1.563 &nbsp;ops/us</span></div>
<div>
<br />
<ul>
<li>Note the decline in throughput for smaller chunks is matched with an increase in poll failures indicating that the consumer is becoming faster than the producer as the chunk grows smaller requiring more frequent allocations by the produce.</li>
<li>Note also that even with 16 slot chunks this option is ~3 times faster than the linked alternative.</li>
<li>Under constant streaming pressure the Chunked queue will be pushed to it's maximum size, which means the producer will be constantly allocating buffers. The producer resize conditions are also slightly trickier and require sampling of the consumer index. The consumer will be slowed down by this sampling, and also slowed down by jumping to new buffers. This problem will be worse as more resizing happens, which is a factor of chunk size.</li>
<li>The benefit of larger chunks will cap out at some point, you could explore this parameter to find the optimum.</li>
<li>An exercise to readers: run the benchmark with the JMH GC profiler and compare the queues. Use it to verify the assumption that Growable produces a bounded amount of garbage, while Chunked continues to churn.</li>
<li>Max throughput is slightly behind Growable.</li>
</ul>
</div>
</div>
The main take aways for sizing here seem to me that tiny chunks are bad, but even with small/medium chunks you can have pretty decent throughput. The right size for your chunk should therefore depend on your expectations of average traffic on the one hand and desirable size when empty.<br />
<br /></div>
<div>
<h3>
Throughput benchmark: unbounded</h3>
</div>
<div>
For unbounded we see the expected&nbsp;increase in throughput as we increase the chunk size&nbsp;&nbsp;(CNK is the chunk size, the max size is infinity and beyond):</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;CNK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Score &nbsp; &nbsp;Error &nbsp; Units</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 offersFailed &nbsp; &nbsp; &nbsp;&#8776; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 offersMade &nbsp; &nbsp; 56.315 &#177; &nbsp;7.563 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 pollsFailed &nbsp; &nbsp;10.823 &#177; &nbsp;1.611 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 16 pollsMade &nbsp; &nbsp; &nbsp;56.315 &#177; &nbsp;7.563 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 offersFailed &nbsp; &nbsp; &nbsp;&#8776; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 offersMade &nbsp; &nbsp;135.119 &#177; 23.306 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 pollsFailed &nbsp; &nbsp; 1.236 &#177; &nbsp;0.851 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;128 pollsMade &nbsp; &nbsp; 131.770 &#177; 21.535 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K offersFailed &nbsp; &nbsp; &nbsp;&#8776; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K offersMade &nbsp; &nbsp;182.922 &#177; &nbsp;3.397 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K pollsFailed &nbsp; &nbsp; 0.005 &#177; &nbsp;0.003 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1K pollsMade &nbsp; &nbsp; 176.208 &#177; &nbsp;3.221 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K offersFailed &nbsp; &nbsp; &nbsp;&#8776; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K offersMade &nbsp; &nbsp;177.586 &#177; &nbsp;2.929 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K pollsFailed &nbsp; &nbsp; 0.031 &#177; &nbsp;0.038 &nbsp;ops/us</span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;16K pollsMade &nbsp; &nbsp; 176.884 &#177; &nbsp;2.255 &nbsp;ops/us</span></div>
<div>
<br />
<ul>
<li>The 16 chunk size is ~4 times faster than the linked list option, as chunk size increases it gets more efficient.</li>
<li>Max throughput is slightly behind growable.</li>
<li>Why is Chunked faster than Unbounded on 128 chunks, but slower on 1K? I've not looked into it, it's taken long enough to write this bloody post as it is. How about you check it out and let me know?</li>
</ul>
<div>
</div>
<br />
<h3>
Throughput benchmark: summary</h3>
<ul>
<li>Growable queue performs well regardless of initial size for this case.</li>
<li>For chunked and unbounded the chunk size has definite implications on throughput. Having said that throughput is very good even for relatively small chunks.&nbsp;</li>
<li>Note that the results for the same benchmark without a GC cycle between iterations were very noisy. The above result intentionally removes the variance GC induces by forcing GC and allowing a large heap. The GC impact of linked array queues when churning will likely be in increasing old generation pressure as the overflow chunks are likely to have been promoted before they get collected. This is assuming a load where overflow is not that frequent and other allocation is present.</li>
</ul>
<br />
<h3>
Interlude</h3>
</div>
<div>
<div class="separator" style="clear: both; text-align: center;">
<a href="https://3.bp.blogspot.com/-SzjozEtCSuY/WE-lwgiR0oI/AAAAAAAADVs/bpAJwP61k7Y-A1BtdU5Os4vBvzIsWV6kgCLcB/s1600/lab%2Bfire2.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="298" src="https://3.bp.blogspot.com/-SzjozEtCSuY/WE-lwgiR0oI/AAAAAAAADVs/bpAJwP61k7Y-A1BtdU5Os4vBvzIsWV6kgCLcB/s320/lab%2Bfire2.jpg" width="320" /></a></div>
Go ahead, grab a beer, or a coffee, a mojito perhaps(Norman/Viktor, go on), or maybe order a large <a href="https://en.wikibooks.org/wiki/Bartending/Cocktails/Pan_Galactic_Gargle_Blaster" target="_blank">Pan Galactic Gargle Blaster</a>, you've earned it. I never thought you'd read this far, it's a tad dry innit? Well, it's not fun writing it either, but we're getting there, just need to look at one more benchmark...<br />
<br />
<h3>
Burst "cost"/latency benchmark: background and method</h3>
</div>
<div>
The burst cost benchmark is a more stable workload than the throughput one. The producer sends a burst of messages to a consumer. The consumer signals completion when the last message in the burst has arrived. The measurement is from first message sent and arrival of last message observed from the producer thread. It's a 'latency' benchmark, or rather an estimate of average communication cost via the particular thread. It's got bells on. It's a friend, and it's a companion, it's the only product you will ever need, follow these easy assembly instructions it never needs ironing.</div>
<div>
This is, I think, a better evaluation of queue characteristics than the throughput benchmark for most applications. Queue starts empty, is hit with a burst of traffic and the burst is drained. The cost measured is inclusive of return signal latency, but as scenarios go this is not too far fetched. Calling this queue latency is a damn sight better than PRETENDING THE BLOODY INVERSE OF THROUGHPUT IS LATENCY. &lt;deep breath&gt;</div>
<div>
Same machine and JMH parameters used as above. All the measurements below are average time per operation in nanoseconds. The <a href="https://github.com/JCTools/JCTools/blob/master/jctools-benchmarks/src/main/java/org/jctools/jmh/latency/QueueBurstCost.java" target="_blank">benchmark code can be found here</a>.</div>
<div>
<br /></div>
<h3>
Burst Cost benchmark: baseline</h3>
<div>
Testing first with SpscArrayQueue and SpscLinkedQueue to establish the expected baseline behaviour, BRST is the size of the burst:</div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">SpscArrayQueue (128k capacity)</span></div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">BRST &nbsp; &nbsp; &nbsp;Score &nbsp; &nbsp; Error &nbsp;Units</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp; 284.709 &#177; &nbsp; 8.813 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp; 368.028 &#177; &nbsp; 6.949 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; &nbsp; 914.150 &#177; &nbsp;11.424 &nbsp;ns/op</span></div>
</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>
<div>
<span style="font-family: inherit;">Right, sending one message has the overhead of cache coherency making data visible to another core. Sending 10/100 messages we can see the benefits of the SpscArrayQueue in allowing consumer and producer to minimize cache coherency overhead per element. We see a satisfying drop in cost per element as the burst size grows (the per element cost is the cost of the burst divided by the number of elements sent, so we see here: 1 -&gt; 284, 10 -&gt; 36, 100 -&gt; 9), but this DOES NOT MEAN THE FRIGGIN' LATENCY IS BLOOMIN' DOWN TO 9ns WHEN WE SEND 100 MESSAGES.</span></div>
<div>
<span style="font-family: inherit;"><br /></span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">SpscLinkedQueue</span></div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">BRST &nbsp; &nbsp; &nbsp;Score &nbsp; &nbsp; Error &nbsp;Units</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp; 378.043 &#177; &nbsp; 7.536 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp;1675.589 &#177; &nbsp;44.496 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; 17036.528 &#177; 492.875 &nbsp;ns/op</span></div>
</div>
</div>
<div>
<br /></div>
<div>
For the linked queue the per element overheads are larger, as well as the cost of scanning through a linked list rather than an array as we poll data out. The gap between the it and SpscArrayQueue widens as the burst size grows. The linked queue fails to make the most of the batching opportunity offered by slack in the queue in other words.</div>
<div>
<br /></div>
<div>
<h3>
Burst Cost benchmark: growable</h3>
</div>
<div>
We expect the growable queue to grow to accommodate the size of the burst. The eventual buffer size will be a tighter fit around the burst size, which in theory might be a benefit as the array is more likely to fit in cache. Let's spin the wheel&nbsp;(CNK is the <b>initial </b>chunk size, the max size is 128K):</div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">BRST &nbsp;CNK &nbsp; &nbsp;Score &nbsp; &nbsp;Error &nbsp;Units</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp;16 &nbsp;327.703 &#177; 11.485 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; 128 &nbsp;292.382 &#177; &nbsp;9.807 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp;1K &nbsp;275.573 &#177; &nbsp;6.230 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; 16K &nbsp;286.354 &#177; &nbsp;6.980 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp;16 &nbsp;599.540 &#177; 73.376 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; 128 &nbsp;386.828 &#177; 10.016 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp;1K &nbsp;376.295 &#177; &nbsp;8.009 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; 16K &nbsp;358.096 &#177; &nbsp;6.107 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; &nbsp;16 1173.644 &#177; 28.669 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; 128 1152.241 &#177; 40.067 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; &nbsp;1K &nbsp;966.612 &#177; &nbsp;9.504 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; 16K &nbsp;951.495 &#177; 12.425 &nbsp;ns/op</span></div>
</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>
<div>
We have to understand the implementation to understand the results here, in particular:</div>
<div>
<ul>
<li>The growable queue buffer will grow to accommodate the burst in a power of 2 sized array. This in particular means that when the burst size is 100 the buffer for the initially smaller 16 chunk queue is also 128. The delta between the 2 configurations becomes marginal once that happens as we see in the 100 burst which forces the initially size 16 element buffer to grow to 128.</li>
<li>The queue tries to probe ahead within a buffer to avoid reading on each element.The read ahead step is a 25% of the buffer size. The smaller the buffer the more often we need to probe ahead (e.g. for a 16 element buffer we do this every 4 elements). This overhead is visible in the smaller buffers.</li>
<li>A burst which manages to fill more than 75% will fail to read ahead with the long probe described above and fall back to reading a single element ahead. This implies that buffers that fit too snugly to the burst size will have worse performance.</li>
<li>When the buffers are sufficiently large the costs closely match the costs observed for the SpscArrayQueue. Yay!</li>
</ul>
<br />
<div>
<h3>
Burst Cost benchmark: chunked</h3>
</div>
</div>
<div>
<div>
For Chunked we see a slight increase in base cost and a bummer when the burst size exceeds the chunk size (CNK is the chunk size, the max size is 128K):</div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">BRST &nbsp;CNK &nbsp; &nbsp;Score &nbsp; &nbsp;Error &nbsp;Units</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp;16 &nbsp;311.743 &#177; 11.613 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; 128 &nbsp;295.987 &#177; &nbsp;5.468 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp;1K &nbsp;281.308 &#177; &nbsp;8.381 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; 16K &nbsp;281.962 &#177; &nbsp;7.376 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp;16 &nbsp;478.687 &#177; 52.547 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; 128 &nbsp;390.041 &#177; 16.029 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp;1K &nbsp;371.067 &#177; &nbsp;7.789 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; 16K &nbsp;386.683 &#177; &nbsp;5.276 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; &nbsp;16 2513.226 &#177; 38.285 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; 128 1117.990 &#177; 14.252 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; &nbsp;1K &nbsp;969.435 &#177; 10.072 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; 16K &nbsp;939.010 &#177; &nbsp;8.173 &nbsp;ns/op</span></div>
</div>
</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>
<div>
<span style="font-family: inherit;">Results are overall similar to the growable, what stands out is:</span></div>
<div>
<ul>
<li>If the chunk is too little to accommodate the burst we see a large increase to cost. Still, comparing this to the SpscLinkedQueue shows a significant benefit. Comparing to the growable version we see the sense in perhaps letting the queue grow to a better size as a response to bursts.</li>
<li>If the chunk is large enough to accommodate the burst behaviour closely matches SpscGrowableArrayQueue. Yay!</li>
</ul>
<br />
<div>
<h3>
Burst Cost benchmark: unbounded</h3>
</div>
<div>
Final one, just hang in there.&nbsp;</div>
<div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">BRST &nbsp;CNK &nbsp; &nbsp;Score &nbsp; &nbsp;Error &nbsp;Units</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp;16 &nbsp;303.030 &#177; 11.812 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; 128 &nbsp;308.158 &#177; 11.064 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; &nbsp;1K &nbsp;286.379 &#177; &nbsp;6.027 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp; 1 &nbsp; 16K &nbsp;282.574 &#177; 10.886 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp;16 &nbsp;554.285 &#177; 54.468 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; 128 &nbsp;407.350 &#177; 11.227 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; &nbsp;1K &nbsp;379.716 &#177; &nbsp;9.357 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">&nbsp;10 &nbsp; 16K &nbsp;370.885 &#177; 12.068 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; &nbsp;16 2748.900 &#177; 64.321 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; 128 1150.393 &#177; 26.355 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; &nbsp;1K 1005.036 &#177; 14.491 &nbsp;ns/op</span></div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">100 &nbsp; 16K &nbsp;979.372 &#177; 13.369 &nbsp;ns/op</span></div>
</div>
<div>
</div>
<div>
<span style="font-family: inherit;"><br /></span></div>
<div>
<span style="font-family: inherit;">What stands out is:</span></div>
<div>
<ul>
<li>If the chunk is too little to accommodate the burst we see a large increase to cost. Still, comparing this to the SpscLinkedQueue shows a significant benefit.</li>
<li>If the chunk is large enough to accommodate the burst and make the most of probing ahead the costs closely resemble the SpscArrayQueue for larger bursts. Yay!</li>
</ul>
<h3>
Burst Cost benchmark: summary</h3>
<div>
We see a pretty much expected result for these queues, which is to say that on the fast path they are the same and therefore if the fast path dominates they show the same costs as a plain SpscArrayQueue, which is good news. When chunks are too small and we have to allocate new chunks we start to see overheads.</div>
<div>
A more subtle observation here is that smaller buffers have some drawbacks as the slow path of the producer code is more likely to be executed. This reflects correctly the empty queue assumption that the JCTools queues rely on, but broken assumptions are... well... broken, so the cost goes up.</div>
<div>
A further consideration here for smaller buffer is the hot/cold structure of the code. It is intended that the producer code inlines the "offer" hot path, but as the cold path is rarely run it will fail to inline it. This is an intentional inlining fail. Inlining the cold path will make the "offer" larger and allot more complex, making the compilers job harder and may result in worse resulting code. When we run with burst/buffer sizes which systematically violate the hot/cold assumption we can trigger a bad inlining decision. This can be worked around by marking the cold methods as "dontinline" using the CompileCommand option or the compiler oracle file.</div>
<h3>
Mmmm... this is boring :(</h3>
</div>
<div class="separator" style="clear: both; text-align: center;">
<a href="https://1.bp.blogspot.com/-AM2ZAFGzXXo/WE-l4ATCTdI/AAAAAAAADVw/sXGQC4zzxaYulxKwLVe6xLy9wHgGkj5JACLcB/s1600/Isaac_Newton_Labratory_Fire-300x207.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="https://1.bp.blogspot.com/-AM2ZAFGzXXo/WE-l4ATCTdI/AAAAAAAADVw/sXGQC4zzxaYulxKwLVe6xLy9wHgGkj5JACLcB/s1600/Isaac_Newton_Labratory_Fire-300x207.jpg" /></a></div>
<div>
Yes... Nothing too surprising happened here, I did not emerge from the lab with my coat on fire, these things happen. One anecdote worth sharing here is that I originally run the benchmarks with only 2 threads allocated to the JVM, this resulted in noisier measurement as I effectively under provisioned the JVM with CPUs for compilation/GC or any OS scheduling contention/interrupts. When running on a 2 core laptop this is a reasonable compromise to fix the cross core topology of the benchmark, but on a server class machine it is easy enough to provision the same topology with more CPUs.</div>
<div>
Next part will feature the astounding extension of these queues to the MPSC domain and will be far more interesting! I promise.</div>
<div>
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><br /></span></div>
<div>
<ul></ul>
</div>
</div>
<div style='clear: both;'></div>
</div>
<div class='post-footer'>
<div class='post-footer-line post-footer-line-1'><span class='post-author vcard'>
</span>
<span class='post-timestamp'>
at
<meta content='http://psy-lob-saw.blogspot.com/2016/12/linked-array-queues-part-2-spsc.html' itemprop='url'/>
<a class='timestamp-link' href='http://psy-lob-saw.blogspot.com/2016/12/linked-array-queues-part-2-spsc.html' rel='bookmark' title='permanent link'><abbr class='published' itemprop='datePublished' title='2016-12-13T09:36:00Z'>09:36:00</abbr></a>
</span>
<span class='post-comment-link'>
<a class='comment-link' href='http://psy-lob-saw.blogspot.com/2016/12/linked-array-queues-part-2-spsc.html#comment-form' onclick=''>
1 comment:
    </a>
</span>
<span class='post-icons'>
<span class='item-control blog-admin pid-1797904270'>
<a href='https://www.blogger.com/post-edit.g?blogID=5171098727364395242&postID=6248079574454576164&from=pencil' title='Edit Post'>
<img alt='' class='icon-action' height='18' src='https://resources.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/>
</a>
</span>
</span>
<div class='post-share-buttons goog-inline-block'>
<a class='goog-inline-block share-button sb-email' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=6248079574454576164&target=email' target='_blank' title='Email This'><span class='share-button-link-text'>Email This</span></a><a class='goog-inline-block share-button sb-blog' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=6248079574454576164&target=blog' onclick='window.open(this.href, "_blank", "height=270,width=475"); return false;' target='_blank' title='BlogThis!'><span class='share-button-link-text'>BlogThis!</span></a><a class='goog-inline-block share-button sb-twitter' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=6248079574454576164&target=twitter' target='_blank' title='Share to Twitter'><span class='share-button-link-text'>Share to Twitter</span></a><a class='goog-inline-block share-button sb-facebook' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=6248079574454576164&target=facebook' onclick='window.open(this.href, "_blank", "height=430,width=640"); return false;' target='_blank' title='Share to Facebook'><span class='share-button-link-text'>Share to Facebook</span></a><a class='goog-inline-block share-button sb-pinterest' href='https://www.blogger.com/share-post.g?blogID=5171098727364395242&postID=6248079574454576164&target=pinterest' target='_blank' title='Share to Pinterest'><span class='share-button-link-text'>Share to Pinterest</span></a><div class='goog-inline-block google-plus-share-container'><g:plusone source='blogger:blog:plusone' href='http://psy-lob-saw.blogspot.com/2016/12/linked-array-queues-part-2-spsc.html' size='medium' width='300' annotation='inline'/></div>
</div>
<span class='post-backlinks post-comment-link'>
</span>
</div>
<div class='post-footer-line post-footer-line-2'><span class='post-labels'>
Labels:
<a href='http://psy-lob-saw.blogspot.com/search/label/Benchmark' rel='tag'>Benchmark</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Experimentation%20Notes' rel='tag'>Experimentation Notes</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Java' rel='tag'>Java</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JCTools' rel='tag'>JCTools</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JMH' rel='tag'>JMH</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/JVM' rel='tag'>JVM</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Lock%20Free' rel='tag'>Lock Free</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/Queue' rel='tag'>Queue</a>,
<a href='http://psy-lob-saw.blogspot.com/search/label/SPSC' rel='tag'>SPSC</a>
</span>
</div>
<div class='post-footer-line post-footer-line-3'><span class='post-location'>
</span>
</div>
</div>
</div>
</div>

        </div></div>
      
</div>
<div class='blog-pager' id='blog-pager'>
<span id='blog-pager-older-link'>
<a class='blog-pager-older-link' href='http://psy-lob-saw.blogspot.com/search?updated-max=2016-12-13T09:36:00Z&amp;max-results=7' id='Blog1_blog-pager-older-link' title='Older Posts'>Older Posts</a>
</span>
<a class='home-link' href='http://psy-lob-saw.blogspot.com/'>Home</a>
</div>
<div class='clear'></div>
<div class='blog-feeds'>
<div class='feed-links'>
Subscribe to:
<a class='feed-link' href='http://psy-lob-saw.blogspot.com/feeds/posts/default' target='_blank' type='application/atom+xml'>Posts (Atom)</a>
</div>
</div>
<script type='text/javascript'>
    window.___gcfg = { 'lang': 'en-GB' };
  </script>
</div></div>
</div>
</div>
<div class='column-left-outer'>
<div class='column-left-inner'>
<aside>
</aside>
</div>
</div>
<div class='column-right-outer'>
<div class='column-right-inner'>
<aside>
<div class='sidebar section' id='sidebar-right-1'><div class='widget BlogSearch' data-version='1' id='BlogSearch1'>
<h2 class='title'>Search This Blog</h2>
<div class='widget-content'>
<div id='BlogSearch1_form'>
<form action='http://psy-lob-saw.blogspot.com/search' class='gsc-search-box' target='_top'>
<table cellpadding='0' cellspacing='0' class='gsc-search-box'>
<tbody>
<tr>
<td class='gsc-input'>
<input autocomplete='off' class='gsc-input' name='q' size='10' title='search' type='text' value=''/>
</td>
<td class='gsc-search-button'>
<input class='gsc-search-button' title='search' type='submit' value='Search'/>
</td>
</tr>
</tbody>
</table>
</form>
</div>
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5171098727364395242&widgetType=BlogSearch&widgetId=BlogSearch1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("BlogSearch1"));' target='configBlogSearch1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div><div class='widget PageList' data-version='1' id='PageList1'>
<h2>Pages</h2>
<div class='widget-content'>
<ul>
<li>
<a href='http://psy-lob-saw.blogspot.com/p/lock-free-queues.html'>Lock Free Queues Index</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/p/jmh-related-posts.html'>JMH Resources</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/p/talks.html'>Talks</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/p/about.html'>About</a>
</li>
</ul>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5171098727364395242&widgetType=PageList&widgetId=PageList1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("PageList1"));' target='configPageList1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div><div class='widget PopularPosts' data-version='1' id='PopularPosts1'>
<h2>Popular Posts</h2>
<div class='widget-content popular-posts'>
<ul>
<li>
<a href='http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html'>Java Flame Graphs Introduction: Fire For Everyone!</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2016/02/why-most-sampling-java-profilers-are.html'>Why (Most) Sampling Java Profilers Are Fucking Terrible </a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2015/12/safepoints.html'>Safepoints: Meaning, Side Effects and Overheads</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html'>How Inlined Code Makes For Confusing Profiles</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2014/10/the-jvm-write-barrier-card-marking.html'>The JVM Write Barrier - Card Marking</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2013/04/lock-free-ipc-queue.html'>135 Million messages a second between processes in pure Java</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2016/06/the-pros-and-cons-of-agct.html'>The Pros and Cons of AsyncGetCallTrace Profilers</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2015/02/hdrhistogram-better-latency-capture.html'>HdrHistogram: A better latency capture method</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2013/05/know-thy-java-object-memory-layout.html'>Know Thy Java Object Memory Layout</a>
</li>
<li>
<a href='http://psy-lob-saw.blogspot.com/2013/05/using-jmh-to-benchmark-multi-threaded.html'>Using JMH to Benchmark Multi-Threaded Code</a>
</li>
</ul>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5171098727364395242&widgetType=PopularPosts&widgetId=PopularPosts1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("PopularPosts1"));' target='configPopularPosts1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div><div class='widget BlogArchive' data-version='1' id='BlogArchive1'>
<h2>Blog Archive</h2>
<div class='widget-content'>
<div id='ArchiveList'>
<div id='BlogArchive1_ArchiveList'>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2018/'>
2018
</a>
<span class='post-count' dir='ltr'>(2)</span>
<ul class='hierarchy'>
<li class='archivedate expanded'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy toggle-open'>

        &#9660;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2018/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
<ul class='posts'>
<li><a href='http://psy-lob-saw.blogspot.com/2018/07/how-inlined-code-confusing-profiles.html'>How Inlined Code Makes For Confusing Profiles</a></li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2018/01/'>
January
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2017/'>
2017
</a>
<span class='post-count' dir='ltr'>(1)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2017/02/'>
February
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2016/'>
2016
</a>
<span class='post-count' dir='ltr'>(9)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2016/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2016/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2016/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2016/06/'>
June
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2016/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2016/02/'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/'>
2015
</a>
<span class='post-count' dir='ltr'>(11)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/10/'>
October
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/08/'>
August
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/07/'>
July
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/05/'>
May
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/04/'>
April
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/03/'>
March
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/02/'>
February
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2015/01/'>
January
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/'>
2014
</a>
<span class='post-count' dir='ltr'>(18)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/12/'>
December
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/08/'>
August
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/07/'>
July
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/06/'>
June
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/04/'>
April
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/03/'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/02/'>
February
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2014/01/'>
January
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/'>
2013
</a>
<span class='post-count' dir='ltr'>(23)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/12/'>
December
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/11/'>
November
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/09/'>
September
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/08/'>
August
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/07/'>
July
</a>
<span class='post-count' dir='ltr'>(5)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/06/'>
June
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/05/'>
May
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/04/'>
April
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/03/'>
March
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/02/'>
February
</a>
<span class='post-count' dir='ltr'>(1)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2013/01/'>
January
</a>
<span class='post-count' dir='ltr'>(3)</span>
</li>
</ul>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2012/'>
2012
</a>
<span class='post-count' dir='ltr'>(6)</span>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2012/12/'>
December
</a>
<span class='post-count' dir='ltr'>(4)</span>
</li>
</ul>
<ul class='hierarchy'>
<li class='archivedate collapsed'>
<a class='toggle' href='javascript:void(0)'>
<span class='zippy'>

        &#9658;&#160;
      
</span>
</a>
<a class='post-count-link' href='http://psy-lob-saw.blogspot.com/2012/10/'>
October
</a>
<span class='post-count' dir='ltr'>(2)</span>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5171098727364395242&widgetType=BlogArchive&widgetId=BlogArchive1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("BlogArchive1"));' target='configBlogArchive1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div><div class='widget Profile' data-version='1' id='Profile1'>
<h2>About Me</h2>
<div class='widget-content'>
<a href='https://plus.google.com/107269247235043577368'><img alt='My photo' class='profile-img' height='80' src='//lh6.googleusercontent.com/-LPZyIqgbGeQ/AAAAAAAAAAI/AAAAAAAAADA/C0pnXZHCmqU/s80-c/photo.jpg' width='80'/></a>
<dl class='profile-datablock'>
<dt class='profile-data'>
<a class='profile-name-link g-profile' href='https://plus.google.com/107269247235043577368' rel='author' style='background-image: url(//www.google.com/images/icons/ui/gprofile_button-16.png);'>
Nitsan Wakart
</a>
<br/>
<div class='g-follow' data-annotation='bubble' data-height='20' data-href='https://plus.google.com/107269247235043577368'></div>
</dt>
</dl>
<a class='profile-link' href='https://plus.google.com/107269247235043577368' rel='author'>View my complete profile</a>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5171098727364395242&widgetType=Profile&widgetId=Profile1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("Profile1"));' target='configProfile1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div>
</div><div class='widget Subscribe' data-version='1' id='Subscribe1'>
<div style='white-space:nowrap'>
<h2 class='title'>Subscribe To</h2>
<div class='widget-content'>
<div class='subscribe-wrapper subscribe-type-POST'>
<div class='subscribe expanded subscribe-type-POST' id='SW_READER_LIST_Subscribe1POST' style='display:none;'>
<div class='top'>
<span class='inner' onclick='return(_SW_toggleReaderList(event, "Subscribe1POST"));'>
<img class='subscribe-dropdown-arrow' src='https://img2.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://img1.blogblog.com/img/icon_feed12.png'/>
Posts
</span>
<div class='feed-reader-links'>
<a class='feed-reader-link' href='https://www.netvibes.com/subscribe.php?url=http%3A%2F%2Fpsy-lob-saw.blogspot.com%2Ffeeds%2Fposts%2Fdefault' target='_blank'>
<img src='https://img1.blogblog.com/img/widgets/subscribe-netvibes.png'/>
</a>
<a class='feed-reader-link' href='https://add.my.yahoo.com/content?url=http%3A%2F%2Fpsy-lob-saw.blogspot.com%2Ffeeds%2Fposts%2Fdefault' target='_blank'>
<img src='https://img1.blogblog.com/img/widgets/subscribe-yahoo.png'/>
</a>
<a class='feed-reader-link' href='http://psy-lob-saw.blogspot.com/feeds/posts/default' target='_blank'>
<img align='absmiddle' class='feed-icon' src='https://img1.blogblog.com/img/icon_feed12.png'/>
                  Atom
                </a>
</div>
</div>
<div class='bottom'></div>
</div>
<div class='subscribe' id='SW_READER_LIST_CLOSED_Subscribe1POST' onclick='return(_SW_toggleReaderList(event, "Subscribe1POST"));'>
<div class='top'>
<span class='inner'>
<img class='subscribe-dropdown-arrow' src='https://img2.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<span onclick='return(_SW_toggleReaderList(event, "Subscribe1POST"));'>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://img1.blogblog.com/img/icon_feed12.png'/>
Posts
</span>
</span>
</div>
<div class='bottom'></div>
</div>
</div>
<div class='subscribe-wrapper subscribe-type-COMMENT'>
<div class='subscribe expanded subscribe-type-COMMENT' id='SW_READER_LIST_Subscribe1COMMENT' style='display:none;'>
<div class='top'>
<span class='inner' onclick='return(_SW_toggleReaderList(event, "Subscribe1COMMENT"));'>
<img class='subscribe-dropdown-arrow' src='https://img2.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://img1.blogblog.com/img/icon_feed12.png'/>
All Comments
</span>
<div class='feed-reader-links'>
<a class='feed-reader-link' href='https://www.netvibes.com/subscribe.php?url=http%3A%2F%2Fpsy-lob-saw.blogspot.com%2Ffeeds%2Fcomments%2Fdefault' target='_blank'>
<img src='https://img1.blogblog.com/img/widgets/subscribe-netvibes.png'/>
</a>
<a class='feed-reader-link' href='https://add.my.yahoo.com/content?url=http%3A%2F%2Fpsy-lob-saw.blogspot.com%2Ffeeds%2Fcomments%2Fdefault' target='_blank'>
<img src='https://img1.blogblog.com/img/widgets/subscribe-yahoo.png'/>
</a>
<a class='feed-reader-link' href='http://psy-lob-saw.blogspot.com/feeds/comments/default' target='_blank'>
<img align='absmiddle' class='feed-icon' src='https://img1.blogblog.com/img/icon_feed12.png'/>
                  Atom
                </a>
</div>
</div>
<div class='bottom'></div>
</div>
<div class='subscribe' id='SW_READER_LIST_CLOSED_Subscribe1COMMENT' onclick='return(_SW_toggleReaderList(event, "Subscribe1COMMENT"));'>
<div class='top'>
<span class='inner'>
<img class='subscribe-dropdown-arrow' src='https://img2.blogblog.com/img/widgets/arrow_dropdown.gif'/>
<span onclick='return(_SW_toggleReaderList(event, "Subscribe1COMMENT"));'>
<img align='absmiddle' alt='' border='0' class='feed-icon' src='https://img1.blogblog.com/img/icon_feed12.png'/>
All Comments
</span>
</span>
</div>
<div class='bottom'></div>
</div>
</div>
<div style='clear:both'></div>
</div>
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5171098727364395242&widgetType=Subscribe&widgetId=Subscribe1&action=editWidget&sectionId=sidebar-right-1' onclick='return _WidgetManager._PopupConfig(document.getElementById("Subscribe1"));' target='configSubscribe1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div><div class='widget PlusFollowers' data-version='1' id='PlusFollowers1'>
<h2 class='title'>Google+ Followers</h2>
<div class='widget-content'>
<div class='g-plus' data-action='followers' data-height='300' data-href='https://plus.google.com/107269247235043577368' data-source='blogger:blog:followers' data-theme='DARK' data-width='190'></div>
<script type='text/javascript'>
        window.___gcfg = {'lang': 'en_GB'};
      </script>
</div>
</div></div>
</aside>
</div>
</div>
</div>
<div style='clear: both'></div>
<!-- columns -->
</div>
<!-- main -->
</div>
</div>
<div class='main-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
<footer>
<div class='footer-outer'>
<div class='footer-cap-top cap-top'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
<div class='fauxborder-left footer-fauxborder-left'>
<div class='fauxborder-right footer-fauxborder-right'></div>
<div class='region-inner footer-inner'>
<div class='foot no-items section' id='footer-1'></div>
<table border='0' cellpadding='0' cellspacing='0' class='section-columns columns-3'>
<tbody>
<tr>
<td class='first columns-cell'>
<div class='foot no-items section' id='footer-2-1'></div>
</td>
<td class='columns-cell'>
<div class='foot no-items section' id='footer-2-2'></div>
</td>
<td class='columns-cell'>
<div class='foot no-items section' id='footer-2-3'></div>
</td>
</tr>
</tbody>
</table>
<!-- outside of the include in order to lock Attribution widget -->
<div class='foot section' id='footer-3'><div class='widget Attribution' data-version='1' id='Attribution1'>
<div class='widget-content' style='text-align: center;'>
Simple theme. Powered by <a href='https://www.blogger.com' target='_blank'>Blogger</a>.
</div>
<div class='clear'></div>
<span class='widget-item-control'>
<span class='item-control blog-admin'>
<a class='quickedit' href='//www.blogger.com/rearrange?blogID=5171098727364395242&widgetType=Attribution&widgetId=Attribution1&action=editWidget&sectionId=footer-3' onclick='return _WidgetManager._PopupConfig(document.getElementById("Attribution1"));' target='configAttribution1' title='Edit'>
<img alt='' height='18' src='https://resources.blogblog.com/img/icon18_wrench_allbkg.png' width='18'/>
</a>
</span>
</span>
<div class='clear'></div>
</div></div>
</div>
</div>
<div class='footer-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</footer>
<!-- content -->
</div>
</div>
<div class='content-cap-bottom cap-bottom'>
<div class='cap-left'></div>
<div class='cap-right'></div>
</div>
</div>
</div>
<script type='text/javascript'>
    window.setTimeout(function() {
        document.body.className = document.body.className.replace('loading', '');
      }, 10);
  </script>
<script type='text/javascript'>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-37666778-1', 'auto', 'blogger');
        ga('blogger.send', 'pageview');
      </script>
<script src='https://apis.google.com/js/plusone.js' type='text/javascript'></script>

<script type="text/javascript" src="https://www.blogger.com/static/v1/widgets/1859629982-widgets.js"></script>
<script type='text/javascript'>
window['__wavt'] = 'AOuZoY5WIALrTqoFsVn9uowOY7hN9Nwu0g:1538283984445';_WidgetManager._Init('//www.blogger.com/rearrange?blogID\x3d5171098727364395242','//psy-lob-saw.blogspot.com/','5171098727364395242');
_WidgetManager._SetDataContext([{'name': 'blog', 'data': {'blogId': '5171098727364395242', 'title': 'Psychosomatic, Lobotomy, Saw', 'url': 'http://psy-lob-saw.blogspot.com/', 'canonicalUrl': 'http://psy-lob-saw.blogspot.com/', 'homepageUrl': 'http://psy-lob-saw.blogspot.com/', 'searchUrl': 'http://psy-lob-saw.blogspot.com/search', 'canonicalHomepageUrl': 'http://psy-lob-saw.blogspot.com/', 'blogspotFaviconUrl': 'http://psy-lob-saw.blogspot.com/favicon.ico', 'bloggerUrl': 'https://www.blogger.com', 'hasCustomDomain': false, 'httpsEnabled': true, 'enabledCommentProfileImages': true, 'gPlusViewType': 'FILTERED_POSTMOD', 'adultContent': false, 'analyticsAccountNumber': 'UA-37666778-1', 'encoding': 'UTF-8', 'locale': 'en-GB', 'localeUnderscoreDelimited': 'en_gb', 'languageDirection': 'ltr', 'isPrivate': false, 'isMobile': false, 'isMobileRequest': false, 'mobileClass': '', 'isPrivateBlog': false, 'feedLinks': '\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Psychosomatic, Lobotomy, Saw - Atom\x22 href\x3d\x22http://psy-lob-saw.blogspot.com/feeds/posts/default\x22 /\x3e\n\x3clink rel\x3d\x22alternate\x22 type\x3d\x22application/rss+xml\x22 title\x3d\x22Psychosomatic, Lobotomy, Saw - RSS\x22 href\x3d\x22http://psy-lob-saw.blogspot.com/feeds/posts/default?alt\x3drss\x22 /\x3e\n\x3clink rel\x3d\x22service.post\x22 type\x3d\x22application/atom+xml\x22 title\x3d\x22Psychosomatic, Lobotomy, Saw - Atom\x22 href\x3d\x22https://www.blogger.com/feeds/5171098727364395242/posts/default\x22 /\x3e\n', 'meTag': '\x3clink rel\x3d\x22me\x22 href\x3d\x22https://plus.google.com/107269247235043577368\x22 /\x3e\n', 'googleProfileUrl': 'https://plus.google.com/107269247235043577368', 'adsenseHostId': 'ca-host-pub-1556223355139109', 'adsenseHasAds': false, 'ieCssRetrofitLinks': '\x3c!--[if IE]\x3e\x3cscript type\x3d\x22text/javascript\x22 src\x3d\x22https://www.blogger.com/static/v1/jsbin/3762807459-ieretrofit.js\x22\x3e\x3c/script\x3e\n\x3c![endif]--\x3e', 'view': '', 'dynamicViewsCommentsSrc': '//www.blogblog.com/dynamicviews/4224c15c4e7c9321/js/comments.js', 'dynamicViewsScriptSrc': '//www.blogblog.com/dynamicviews/3b4dbd5bc7a45d5b', 'plusOneApiSrc': 'https://apis.google.com/js/plusone.js', 'sharing': {'platforms': [{'name': 'Get link', 'key': 'link', 'shareMessage': 'Get link', 'target': ''}, {'name': 'Facebook', 'key': 'facebook', 'shareMessage': 'Share to Facebook', 'target': 'facebook'}, {'name': 'BlogThis!', 'key': 'blogThis', 'shareMessage': 'BlogThis!', 'target': 'blog'}, {'name': 'Twitter', 'key': 'twitter', 'shareMessage': 'Share to Twitter', 'target': 'twitter'}, {'name': 'Pinterest', 'key': 'pinterest', 'shareMessage': 'Share to Pinterest', 'target': 'pinterest'}, {'name': 'Google+', 'key': 'googlePlus', 'shareMessage': 'Share to Google+', 'target': 'googleplus'}, {'name': 'Email', 'key': 'email', 'shareMessage': 'Email', 'target': 'email'}], 'googlePlusShareButtonWidth': 300, 'googlePlusBootstrap': '\x3cscript type\x3d\x22text/javascript\x22\x3ewindow.___gcfg \x3d {\x27lang\x27: \x27en_GB\x27};\x3c/script\x3e'}, 'hasCustomJumpLinkMessage': false, 'jumpLinkMessage': 'Read more', 'pageType': 'index', 'pageName': '', 'pageTitle': 'Psychosomatic, Lobotomy, Saw', 'metaDescription': 'Blog on Java, Performance, Concurrency, NIO, Unsafe, Low latency, Programming, Software, Philosophy'}}, {'name': 'features', 'data': {'cmt_anon_warn': 'false', 'sharing_get_link_dialog': 'true', 'sharing_native': 'false'}}, {'name': 'messages', 'data': {'edit': 'Edit', 'linkCopiedToClipboard': 'Link copied to clipboard', 'ok': 'Ok', 'postLink': 'Post link'}}, {'name': 'template', 'data': {'name': 'custom', 'localizedName': 'Custom', 'isResponsive': false, 'isAlternateRendering': false, 'isCustom': true, 'variant': 'bold', 'variantId': 'bold'}}, {'name': 'view', 'data': {'classic': {'name': 'classic', 'url': '?view\x3dclassic'}, 'flipcard': {'name': 'flipcard', 'url': '?view\x3dflipcard'}, 'magazine': {'name': 'magazine', 'url': '?view\x3dmagazine'}, 'mosaic': {'name': 'mosaic', 'url': '?view\x3dmosaic'}, 'sidebar': {'name': 'sidebar', 'url': '?view\x3dsidebar'}, 'snapshot': {'name': 'snapshot', 'url': '?view\x3dsnapshot'}, 'timeslide': {'name': 'timeslide', 'url': '?view\x3dtimeslide'}, 'isMobile': false, 'title': 'Psychosomatic, Lobotomy, Saw', 'description': 'Blog on Java, Performance, Concurrency, NIO, Unsafe, Low latency, Programming, Software, Philosophy', 'url': 'http://psy-lob-saw.blogspot.com/', 'type': 'feed', 'isSingleItem': false, 'isMultipleItems': true, 'isError': false, 'isPage': false, 'isPost': false, 'isHomepage': true, 'isArchive': false, 'isLabelSearch': false}}]);
_WidgetManager._RegisterWidget('_NavbarView', new _WidgetInfo('Navbar1', 'navbar', null, document.getElementById('Navbar1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_HeaderView', new _WidgetInfo('Header1', 'header', null, document.getElementById('Header1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogView', new _WidgetInfo('Blog1', 'main', null, document.getElementById('Blog1'), {'cmtInteractionsEnabled': false, 'useNgc': false, 'lightboxEnabled': true, 'lightboxModuleUrl': 'https://www.blogger.com/static/v1/jsbin/1209678082-lbx__en_gb.js', 'lightboxCssUrl': 'https://www.blogger.com/static/v1/v-css/368954415-lightbox_bundle.css'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogSearchView', new _WidgetInfo('BlogSearch1', 'sidebar-right-1', null, document.getElementById('BlogSearch1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_PageListView', new _WidgetInfo('PageList1', 'sidebar-right-1', null, document.getElementById('PageList1'), {'title': 'Pages', 'links': [{'isCurrentPage': false, 'href': 'http://psy-lob-saw.blogspot.com/p/lock-free-queues.html', 'id': '965323808017462839', 'title': 'Lock Free Queues Index'}, {'isCurrentPage': false, 'href': 'http://psy-lob-saw.blogspot.com/p/jmh-related-posts.html', 'id': '4459888590190791177', 'title': 'JMH Resources'}, {'isCurrentPage': false, 'href': 'http://psy-lob-saw.blogspot.com/p/talks.html', 'id': '2635032725986214571', 'title': 'Talks'}, {'isCurrentPage': false, 'href': 'http://psy-lob-saw.blogspot.com/p/about.html', 'id': '8848338426403950310', 'title': 'About'}], 'mobile': false}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_PopularPostsView', new _WidgetInfo('PopularPosts1', 'sidebar-right-1', null, document.getElementById('PopularPosts1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_BlogArchiveView', new _WidgetInfo('BlogArchive1', 'sidebar-right-1', null, document.getElementById('BlogArchive1'), {'languageDirection': 'ltr', 'loadingMessage': 'Loading\x26hellip;'}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_ProfileView', new _WidgetInfo('Profile1', 'sidebar-right-1', null, document.getElementById('Profile1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_SubscribeView', new _WidgetInfo('Subscribe1', 'sidebar-right-1', null, document.getElementById('Subscribe1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_PlusFollowersView', new _WidgetInfo('PlusFollowers1', 'sidebar-right-1', null, document.getElementById('PlusFollowers1'), {}, 'displayModeFull'));
_WidgetManager._RegisterWidget('_AttributionView', new _WidgetInfo('Attribution1', 'footer-3', null, document.getElementById('Attribution1'), {}, 'displayModeFull'));
</script>
</body>
</html>